"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2236],{71698:function(e,t,s){s.d(t,{QC:function(){return r},ZC:function(){return i},fw:function(){return a}});let a=5e3,i=2500,r=3e3},65332:function(e,t,s){s.d(t,{M:function(){return a}});let a=(0,s(22867).y)()},41133:function(e,t,s){let a,i,r;s.d(t,{Rv:function(){return G},Ok:function(){return r},mx:function(){return L}});var n,d,u=s(2784),l=s(39905),o=s(61569),h=s(53645),c=s(6364),_=s(5813);let m={fetchChatMessageHistory:async(e,t)=>(0,o.o)().get("/chat/history/msgs/user/",{params:{history_external_id:e,page_num:t}}).catch(e=>Promise.reject(e)),fetchChatCreateHistory:async e=>(0,o.o)().post("/chat/history/create/",{character_external_id:e}).catch(e=>Promise.reject(e)),fetchChatContinuedHistory:async(e,t)=>(0,o.o)().post("/chat/history/continue/",{character_external_id:e,history_external_id:t}).catch(e=>Promise.reject(e)),fetchCharacterInfo:async e=>(0,o.o)().post("/chat/character/info/",{external_id:e}).catch(e=>Promise.reject(e)),fetchCharacterInfoCached:async e=>await (0,o.o)().post("/chat/character/info/",{external_id:e}).catch(e=>Promise.reject(e)),abortChatMessage:async(e,t,s)=>await (0,o.o)().post("/chat/history/msgs/cancel/",{history_id:e,msg_uuid:t,num_letters:s}).catch(e=>Promise.reject(e)),deleteMessages:async(e,t)=>{let s=t.filter(e=>e!==v&&e!==_.gn);return"OK"===(await (0,o.o)().post("chat/history/msgs/delete/",{history_id:e,uuids_to_delete:s}).catch(e=>Promise.reject(e))).data.status}};var g=s(99503);class p{async initialize(e,t){await this.fetchInitialData(this.external_id,this.history_external_id,e,t)}isInitialized(){return!!this.chatHistory}subscribe(e){this.subscriberCallbacks.push(e)}unsubscribe(e){this.subscriberCallbacks=this.subscriberCallbacks.filter(t=>t!==e)}publishChatMessages(e){let t=null!=e?e:this.turns;if(this.serviceType===_.Em.Legacy){var s,a;t=(null===(s=this.messages)||void 0===s?void 0:s.length)>0?(0,g.$s)(this.messages,null===(a=this.chatHistory)||void 0===a?void 0:a.chat_id):[]}t=(0,g.nT)(t),this.subscriberCallbacks.forEach(e=>e(t,this.primaryCandidateMap,this.chatHistory)),this.onChatEventCallback(_.qN.messages,{messages:t})}removeClientMessages(e){this.turns=this.turns.filter(t=>!e.includes(t.turn_key.turn_id)),this.publishChatMessages()}async deleteMessages(e,t){(0,l.nC)("implementer must implement this")}async fetchInitialData(e,t,s,a){try{let a;if(this.status!==_.HH.none)return;if(this.setStatus(_.HH.fetchingHistory),!this.charData){let t=await m.fetchCharacterInfo(e);if(!t)return;this.charData=t.data.character}a=s?await m.fetchChatCreateHistory(e):await m.fetchChatContinuedHistory(e,t),this.chatHistory=(0,g.gw)(a.data)}catch(t){var i,r;if((null===(i=t.response)||void 0===i?void 0:i.status)>=400&&(null===(r=t.response)||void 0===r?void 0:r.status)<500){let t=await m.fetchChatCreateHistory(e);this.chatHistory=(0,g.gw)(t.data)}}finally{this.setStatus(_.HH.none),this.has_more=!0,this.next_page=-1,this.fetchMessageHistory(t,s)}}async fetchMessageHistory(e,t){var s,a,i,r,n,d,u,o,h;let g=e||(null===(s=this.chatHistory)||void 0===s?void 0:s.chat_id);if((this.has_more||t)&&this.status===_.HH.none&&g)try{t&&(this.next_page=-1,this.has_more=!0),this.setStatus(_.HH.fetchMessages);let e=await m.fetchChatMessageHistory(g,-1!==this.next_page?this.next_page:void 0);t?this.messages=null!==(a=e.data.messages)&&void 0!==a?a:[]:this.messages=[...null!==(i=e.data.messages)&&void 0!==i?i:[],...this.messages],this.has_more=e.data.has_more,this.next_page=e.data.next_page,this.messages.length>0&&(this.messages=this.messages.map(e=>({...e,clientUUID:(0,c.Z)()}))),this.messages.length>1&&!this.messages[this.messages.length-1].src__is_human&&this.messages.push({text:"",deleted:!1,id:-1,uuid:_.gn,image_prompt_text:"",image_rel_path:"",is_alternative:!0,responsible_user__username:"",src__character__avatar_file_name:null!==(u=null===(r=this.charData)||void 0===r?void 0:r.avatar_file_name)&&void 0!==u?u:"",src__is_human:!1,src__name:null!==(o=null===(n=this.charData)||void 0===n?void 0:n.name)&&void 0!==o?o:"",src__user__username:"",src_char:{participant:this.charData,avatar_file_name:null!==(h=null===(d=this.charData)||void 0===d?void 0:d.avatar_file_name)&&void 0!==h?h:""},badge_reason:"",clientUUID:(0,c.Z)()}),this.publishChatMessages()}catch(e){(0,l.Jx)("failed to get messages",e),this.onChatEventCallback(_.qN.receive_fail,{message:"Failed to get messages",external_id:this.external_id})}finally{this.setStatus(_.HH.none)}}appendMessage(e){this.messages.push(e),this.publishChatMessages()}appendTurn(e){-1===this.turns.findIndex(t=>t.turn_key.turn_id===e.turn_key.turn_id)?(this.turns=[e,...this.turns],this.publishChatMessages()):(0,l.Jx)("duplicate turns detected during add turn")}updateTurn(e,t){let s=this.turns.findIndex(e=>e.turn_key.turn_id===t);s>-1?(this.turns[s]={...e,...this.turns[s]},this.publishChatMessages()):(0,l.Jx)("Couldn't find turn to update")}updateCandidate(e,t,s,a){var i;let r=this.turns.findIndex(e=>e.turn_key.turn_id===t),n=null!==(i=null==a?void 0:a.editedCandidate)&&void 0!==i?i:e.candidates[0];if(n.request_id=s,n.fresh=!0,r>-1&&n){let t=n.candidate_id?this.turns[r].candidates.findIndex(e=>e.candidate_id===n.candidate_id):-1;if(t>-1?this.turns[r].candidates[t]=n:this.turns[r].candidates.push(n),this.publishChatMessages(),null==a?void 0:a.editedCandidate){let s=t>-1?t:this.turns[r].candidates.length-1;this.updatePrimaryCandidateMap(e.turn_key.turn_id,s),this.onChatEventCallback(_.qN.message_edited,{turnId:e.turn_key.turn_id,editedIndex:s})}}else(0,l.Jx)("Couldn't find turn to update")}popMessage(){this.messages.pop(),this.publishChatMessages()}refreshHistory(e){if(this.charData){var t;this.publishChatMessages(),this.fetchInitialData(null===(t=this.charData)||void 0===t?void 0:t.external_id,void 0,e)}}cleanup(){}sendChatMessage(e){throw Error("sendChatMessage must be implemented by extended class")}updatePrimaryCandidateMap(e,t){this.primaryCandidateMap[e]=t}setPrimaryCandidateOfTurn(e,t){}buildRequestId(){return(0,c.Z)().slice(0,24)+this.instanceID}setStatus(e){this.status!==_.HH.dead&&(this.status=e)}getStatus(){return this.status}setUser(e){this.user=e}constructor(e,t,s,a,i,r){this.wsRetryAttemps=0,this.instanceID=t.slice(-12),this.serviceType=e,this.onChatEventCallback=a,this.messages=[],this.turns=[],this.external_id=t,this.history_external_id=i,this.subscriberCallbacks=[],this.user=s,this.status=_.HH.none,this.charData=r,this.has_more=!0,this.next_page=-1,this.primaryCandidateMap={}}}let v="loading_msg";class b extends p{async initialize(e,t){await super.initialize(e,t),this.publishChatMessages()}async deleteMessages(e,t){if(this.chatHistory)try{var s;let a=await m.deleteMessages(null===(s=this.chatHistory)||void 0===s?void 0:s.chat_id,e);this.fetchMessageHistory(void 0,!0),t(a)}catch(t){(0,l.nC)("failed to delete messages",t,e)}}sendChatMessage(e){if("legacy"!==e.type)throw Error("Only legacy publish command is supported by ChatInstanceFetchAsync: ".concat(e.type));let{messageText:t,generatingCandidates:s,primaryCandidateId:a,retryLastUserMsg:i,abortCurrentMsg:r}=e;if(this.getStatus()!==_.HH.cancelling){if(this.getStatus()!==_.HH.none?(this.abortedUUID=this.lastUUID,this.setStatus(_.HH.cancelling)):s||(this.messages.length>1&&!i&&this.messages[this.messages.length-1].uuid===_.gn&&this.messages.splice(this.messages.length-1,1),this.publishChatMessages()),r)this.addDummyMessage(),this.publishChatMessages();else{if(s);else{var n,d,u,l,o,h,m,g,p,b,y,f,k,C,M;i||""===t||this.appendMessage({text:null!=t?t:"",deleted:!1,uuid:_.Nm,id:-1,image_prompt_text:"",image_rel_path:"",is_alternative:!1,responsible_user__username:"",src__character__avatar_file_name:null!==(p=null===(l=this.user)||void 0===l?void 0:l.avatar_file_name)&&void 0!==p?p:"",src__is_human:!0,src__name:null!==(b=null===(o=this.user)||void 0===o?void 0:o.name)&&void 0!==b?b:"",src__user__username:null!==(y=null===(m=this.user)||void 0===m?void 0:null===(h=m.user)||void 0===h?void 0:h.username)&&void 0!==y?y:"",src_char:{participant:this.user,avatar_file_name:null!==(f=null===(g=this.user)||void 0===g?void 0:g.avatar_file_name)&&void 0!==f?f:""},badge_reason:"",clientUUID:(0,c.Z)(),fresh:!0}),this.appendMessage({text:"",deleted:!1,uuid:v,id:-2,image_prompt_text:"",image_rel_path:"",is_alternative:!1,responsible_user__username:"",src__character__avatar_file_name:null!==(k=null===(n=this.charData)||void 0===n?void 0:n.avatar_file_name)&&void 0!==k?k:"",src__is_human:!1,inProgress:!0,src__name:null!==(C=null===(d=this.charData)||void 0===d?void 0:d.name)&&void 0!==C?C:"",src__user__username:"",src_char:{participant:this.charData,avatar_file_name:null!==(M=null===(u=this.charData)||void 0===u?void 0:u.avatar_file_name)&&void 0!==M?M:""},badge_reason:"",clientUUID:(0,c.Z)(),fresh:!0})}if(this.getStatus()!==_.HH.cancelling)this._sendChatMessageLegacyFetchNoWhile(t,s,a,i);else{let e=setInterval(()=>{this.getStatus()!==_.HH.cancelling&&(this._sendChatMessageLegacyFetchNoWhile(t,s,a),clearInterval(e))},100)}}}}async _sendChatMessageLegacyFetchNoWhile(e,t,s,a){try{var i,r,n,d;this.setStatus(_.HH.sending),this.replaceDummyUUID();let u={history_external_id:null===(i=this.chatHistory)||void 0===i?void 0:i.chat_id,character_external_id:null===(r=this.charData)||void 0===r?void 0:r.external_id,text:e,tgt:null===(n=this.charData)||void 0===n?void 0:n.participant__user__username,ranking_method:"random",staging:!1,enable_tti:!1,stream_every_n_steps:16,is_proactive:!1,image_rel_path:"",image_description:"",image_description_type:"",image_origin_type:"",voice_enabled:!1,parent_msg_uuid:t?this.getLastMessageUUID():null,primary_msg_uuid:t?null:s,seen_msg_ids:[],num_candidates:1,filter_candidates:null,give_room_introductions:!0,initial_timeout:null,insert_beginning:null,livetune_coeff:null,model_server_address:null,override_prefix:null,override_rank:null,prefix_limit:null,prefix_token_limit:null,rank_candidates:null,retry_last_user_msg_id:null,unsanitized_characters:null,retry_last_user_msg_uuid:a?this.getLastMessageUUID():null},h="".concat((0,o.o)().defaults.baseURL,"/chat/streaming/"),c=null,p=(0,o.o)().defaults.headers.common,v={};for(let e in p){let t=p[e];t&&(v[e]=t.toString())}let b=await fetch(h,{method:"POST",headers:v,reactNative:{textStreaming:!0},body:JSON.stringify(u)}),y=null==b?void 0:null===(d=b.body)||void 0===d?void 0:d.getReader();null==y||y.closed.then(()=>{(0,l.BS)("Stream reader closed",l.UI.log)}).catch(()=>{(0,l.BS)("Stream reader error",l.UI.warn),this.onChatEventCallback(_.qN.receive_fail,{message:"Failed to decode message",external_id:this.external_id}),this.handleServerAbort(t),(0,g.Ze)(M)});let f="",k=!0,C=0,M=(0,g.L8)(async()=>{var e,s,a,i,r,n;let d="";try{let{value:e,done:t}=await y.read();d=e}catch(e){}try{f+=new TextDecoder().decode(d)}catch(e){(0,l.Jx)("failed to decode text",e)}if(k)try{let t=JSON.parse(f);(null==t?void 0:null===(e=t.replies)||void 0===e?void 0:e.length)>0?this.backfillUUIds(null==t?void 0:t.replies[0].uuid,t.last_user_msg_uuid):this.backfillUUIds("",t.last_user_msg_uuid),(null==t?void 0:t.force_login)&&this.sendGuestLimitMessage(),k=!1}catch(e){if(++C>120){try{this.onChatEventCallback(_.qN.receive_fail,{message:"Failed to decode message",external_id:this.external_id}),this.handleServerAbort(t)}catch(e){}(0,g.Ze)(M);return}}let u=f.indexOf("\n");if(-1===u)return;let o=f.substring(0,u);if(f=f.substring(u+1),this.abortedUUID&&(null==c?void 0:c.replies)&&c.replies.length>0&&c.replies[0].uuid===this.abortedUUID){await m.abortChatMessage(null!==(a=null===(s=this.chatHistory)||void 0===s?void 0:s.chat_id)&&void 0!==a?a:"",this.abortedUUID,c.replies[0].text.length),this.abortedUUID=void 0,this.finalizeMessage(c,!0),(0,g.Ze)(M),this.setStatus(_.HH.none);return}try{c=JSON.parse(o)}catch(e){(0,l.Jx)("failed to parse data:",e)}if((null==c?void 0:c.abort)&&((null==c?void 0:c.error)==="unauthorized"?(this.onChatEventCallback(_.qN.abort,{message:"unauthorized",uuid:c.uuid,external_id:this.external_id}),this.handleServerAbort(t)):(null==c?void 0:c.error)==="No eligible candidates"?(this.onChatEventCallback(_.qN.filter,{message:"No eligible candidates",uuid:c.uuid,external_id:this.external_id}),this.handleServerAbort(t)):c.error&&(this.onChatEventCallback(_.qN.receive_fail,{message:"Unexpected message generation error",uuid:c.uuid,external_id:this.external_id}),this.handleServerAbort(t)),(0,g.Ze)(M)),null==c?void 0:c.replies){this.populateMissingCandidatesIds(c.replies,-1);let e=c.replies[0].text;this.lastUUID=c.replies[0].uuid,this.updateMessage(e,c.replies[0].uuid),c.is_final_chunk&&((0,g.Ze)(M),this.setStatus(_.HH.none),this.finalizeMessage(c),(null==c?void 0:null===(i=c.replies)||void 0===i?void 0:i.length)>0&&this.onChatEventCallback(_.qN.message_finished,{uuid:c.replies[0].uuid,participant_name:null===(r=this.charData)||void 0===r?void 0:r.participant__name,messageText:c.replies[0].text,external_id:null===(n=this.charData)||void 0===n?void 0:n.external_id}))}if(!y){(0,g.Ze)(M),this.setStatus(_.HH.none),this.finalizeMessage(c);return}},16)}catch(e){(0,l.Jx)("legacy chat stream error:",e)}}getLastMessageUUID(){if(this.messages){for(let e=this.messages.length-1;e>=0;e--)if(!this.messages[e].deleted&&this.messages[e].src__is_human)return this.messages[e].uuid}}finalizeMessage(e,t){try{if(this.messages){let s=[...this.messages];if((null==e?void 0:e.replies[0])&&s.length>1){let t=s.findIndex(t=>t.uuid===e.replies[0].uuid);t>-1&&(s[t].id=e.replies[0].id,s[t].inProgress=!1,s[t].fresh=!0,s[t].text=e.replies[0].text,s[t].image_rel_path=e.replies[0].image_rel_path,s[t].image_rel_path),this.messages=[...s]}if(e.last_user_msg_id>0&&s.length>1){let t=s.findIndex(e=>-2===e.id);t>-1&&(s[t].id=e.last_user_msg_id),this.messages=[...s]}t||this.addDummyMessage(),this.publishChatMessages()}}catch(e){(0,l.Jx)("finalize message error:",e)}}updateMessage(e,t){try{let s=this.messages.findIndex(e=>e.uuid===t);if(s>-1){let a=[...this.messages];a[s].text=e,a[s].uuid=t,a[s].inProgress=!0,this.messages=a,this.publishChatMessages()}else{(0,l.Jx)("couldnt find message to update, gonna try loading message:",t);let s=this.messages.findIndex(e=>e.uuid===v);if(s>-1){let a=[...this.messages];a[s].text=e,a[s].uuid=t,a[s].inProgress=!0,this.messages=a,(0,l.Jx)("successfully updated but with fallback! oh no!"),this.publishChatMessages()}}}catch(e){(0,l.Jx)("failed to updateMessage:",e)}}sendGuestLimitMessage(){try{let e=this.messages.findIndex(e=>e.uuid===v);if(e>-1){let t=[...this.messages];t[e].force_signin=!0,this.messages=t,this.publishChatMessages()}else(0,l.Jx)("failed to find dummy message")}catch(e){(0,l.Jx)("failed to updateMessage:",e)}}constructor(e,t,s,a,i,r){super(e,t,s,a,i,r),this.handleServerAbort=e=>{this.popMessage(),e&&(this.addDummyMessage(),this.publishChatMessages()),this.setStatus(_.HH.none)},this.replaceDummyUUID=()=>{let e=[...this.messages];if(e.length>1){let t=e.findIndex(e=>e.uuid===_.gn);t>-1&&(e[t].uuid=v)}this.messages=[...e],this.publishChatMessages()},this.backfillUUIds=(e,t)=>{let s=[...this.messages];if(e&&s.length>1){let t=s.findIndex(e=>e.uuid===v);t>-1&&(s[t].uuid=e)}if(t&&s.length>1){let e=s.findIndex(e=>e.uuid===_.Nm);e>-1&&(s[e].uuid=t)}this.messages=[...s],this.publishChatMessages()},this.populateMissingCandidatesIds=(e,t)=>{try{if(e&&"object"==typeof e)for(let s of e)s.id||(s.id=t)}catch(e){(0,l.Jx)("failed to populate missing candidate ids:",e)}},this.addDummyMessage=()=>{var e,t,s,a,i,r;this.messages.push({text:"",deleted:!1,id:-1,uuid:_.gn,image_prompt_text:"",image_rel_path:"",is_alternative:!0,responsible_user__username:"",src__character__avatar_file_name:null!==(a=null===(e=this.charData)||void 0===e?void 0:e.avatar_file_name)&&void 0!==a?a:"",src__is_human:!1,src__name:null!==(i=null===(t=this.charData)||void 0===t?void 0:t.name)&&void 0!==i?i:"",src__user__username:"",src_char:{participant:this.charData,avatar_file_name:null!==(r=null===(s=this.charData)||void 0===s?void 0:s.avatar_file_name)&&void 0!==r?r:""},badge_reason:"",clientUUID:(0,c.Z)(),fresh:!0})}}}var y=s(54504),f=s(71698),k=s(75658),C=s(82678),M=s(26498);class I{async authenticate(){if("unauthenticated"===this.authState)try{this.authState="authenticating",await M.m.ping(),this.authState="authenticated"}catch(e){l.$G.logError("Failed to authenticate websocket",{error:e}),this.authState="unauthenticated"}}disconnectWebsocket(){}checkAuthentication(e){let{message:t,code:s}=e;(403===s||401===s||(null==t?void 0:t.includes("403"))||(null==t?void 0:t.includes("401"))||(null==t?void 0:t.toLowerCase().includes("unauthorized")))&&(this.authState="unauthenticated")}restartTTLTimer(){clearTimeout(this.ttlTimer);let e=(0,h.cD)();e>0&&(this.ttlTimer=setTimeout(()=>{this.disconnectWebsocket()},e))}augmentDebugPayload(e){let{debugModeEnabled:t,hermesGenerationEnabled:s,hermesGenerationTemplate:a,modelServerURLOverride:i,chatstackParams:r,debugWSPayload:n}=(0,h.$K)();e.payload&&(t&&(e.payload.debug_info=t),i&&(e.payload.model_server_url=i),r&&(e.payload.chatstack_params=r),s&&(e.payload.use_hermes_generation=s),a&&(e.payload.hermes_generation_template=a),n&&(e.payload={...e.payload,...n}))}constructor(e){this.ttlTimer=0,this.authState="unauthenticated",this.onChatEventCallback=e,this.restartTTLTimer()}}class T{subscribe(e,t,s,a){this.subscribers[e]={onMessageCallback:t,onErrorCallback:s,onSocketConnected:a}}unsubscribe(e){delete this.subscribers[e]}publish(e,t){var s;null===(s=this.subscribers[t])||void 0===s||s.onMessageCallback(e)}raiseError(e){var t;null===(t=this.subscribers[e])||void 0===t||t.onErrorCallback()}socketConnected(e){var t,s;null===(s=this.subscribers[e])||void 0===s||null===(t=s.onSocketConnected)||void 0===t||t.call(s)}constructor(){this.subscribers={}}}let x=new T;class S extends I{subscribeToRoom(e,t){var s;let a=null===(s=this.roomSubscriptions[e])||void 0===s?void 0:s.subscription,i=this.buildChannelName(e);a||(a=this.centrifuge.newSubscription(i)).on("publication",e=>this.handlePublication(e)),this.roomSubscriptions[e]={subscription:a,instanceId:t},a.subscribe()}unsubscribeFromRoom(e){var t,s;null===(s=this.roomSubscriptions[e])||void 0===s||null===(t=s.subscription)||void 0===t||t.unsubscribe()}async send(e,t){this.restartTTLTimer(),await this.reconnectWebsocket(),this.augmentDebugPayload(e),e.origin_id=(0,h.g1)();try{if(t){await this.centrifuge.publish(this.buildChannelName(t),e);return}let s=await this.centrifuge.rpc("unused_command",e);this.publishRpcResponses&&this.publishResponseData(s.data)}catch(s){l.$G.logError("centrifuge send error",{error:s,extra:{code:s.code,message:s.message}});let t=(0,g.EQ)(e.request_id);if(s.message)try{let e=JSON.parse(s.message);(null==e?void 0:e.command)===k.zd.neo_error?x.publish(e,t):x.raiseError(t);return}catch(e){x.raiseError(t)}x.raiseError(t)}}async setupWebsocket(){await this.authenticate(),this.centrifuge.connect()}disconnectWebsocket(){this.centrifuge.disconnect()}async reconnectWebsocket(){await this.setupWebsocket()}buildChannelName(e){return"room:".concat(e)}handlePublication(e){this.restartTTLTimer(),this.publishResponseData(e.data)}publishResponseData(e){var t;let s=null!==(t=null==e?void 0:e.request_id)&&void 0!==t?t:null==e?void 0:e.id;if(s)try{let t=(0,g.EQ)(s);x.publish(e,t)}catch(e){l.$G.logError("centrifuge publication error",{error:e})}}constructor(e,t,s){super(e),this.publishRpcResponses=t;let a=[{transport:"websocket",endpoint:(0,h.VX)()},{transport:"sse",endpoint:(0,h.s7)()}],i=(0,h.m3)();this.centrifuge=new C.qX(a,{timeout:(0,h.iY)(),eventsource:i,emulationEndpoint:(0,h.h$)()}),this.centrifuge.on("connected",e=>{Object.values(this.roomSubscriptions).forEach(e=>{x.socketConnected(e.instanceId)}),this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.open})}),this.centrifuge.on("disconnected",e=>{this.checkAuthentication({message:e.reason,code:e.code}),this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.closed})}),this.centrifuge.on("error",e=>{this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.error}),this.onChatEventCallback(_.qN.websocket_error,{comment:e.error.message,error_code:e.error.code})}),s&&(this.userSubscription=this.centrifuge.newSubscription("user#".concat(s)),this.userSubscription.on("publication",e=>this.handlePublication(e)),this.userSubscription.subscribe()),this.roomSubscriptions={}}}(n=d||(d={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED";class w extends I{isConnected(){var e;return(null===(e=this.socket)||void 0===e?void 0:e.readyState)===1}isConnectedOrConnecting(){var e,t;return"authenticating"===this.authState||(null===(e=this.socket)||void 0===e?void 0:e.readyState)===1||(null===(t=this.socket)||void 0===t?void 0:t.readyState)===0}send(e){this.isConnected()?this.sendInternal(e):(this.sendQueue.push(e),this.reconnectWebsocket())}disconnectWebsocket(){this.socket&&(clearInterval(this.heartbeatInterval),clearTimeout(this.wsRetryTimeout),clearTimeout(this.ttlTimer),this.socket.onopen=null,this.socket.onerror=null,this.socket.onmessage=null,this.socket.onclose=null,this.socket.close(),this.socket=null)}reconnectWebsocket(){this.wsRetryAttemps=0,this.isConnectedOrConnecting()||this.setupWebsocket()}subscribeToRoom(e){throw Error("Not implemented: Trying to use native websockets with rooms")}unsubscribeFromRoom(e){throw Error("Not implemented: Trying to use native websockets with rooms")}async setupWebsocket(){await this.authenticate(),this.createWebsocket()}createWebsocket(){this.disconnectWebsocket(),this.socket=new WebSocket((0,h.ti)()),this.socket.onopen=()=>{this.wsRetryAttemps=0,this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.open}),this.sendQueue.forEach(e=>{this.sendInternal(e)}),this.sendQueue=[];let e=(0,h.YW)();e>0&&(this.heartbeatInterval=setInterval(()=>{this.sendInternal({command:k.OY.ping})},e))},this.socket.onerror=e=>{this.checkAuthentication(e),this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.error}),this.onChatEventCallback(_.qN.websocket_error,{comment:e.message,error_code:""}),this.raiseErrorCallbacksForPendingRequests()},this.socket.onclose=e=>{this.checkAuthentication(e),this.disconnectWebsocket(),this.raiseErrorCallbacksForPendingRequests(),this.wsRetryAttemps<5?(this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.reconnecting}),this.wsRetryTimeout=setTimeout(()=>{this.wsRetryAttemps++,this.setupWebsocket()},500*2**this.wsRetryAttemps)):this.onChatEventCallback(_.qN.websocket_status,{status:_.$3.closed})},this.socket.onmessage=e=>{this.restartTTLTimer();let t=JSON.parse(e.data);if(t.request_id){this.removeInflightRequest(t.request_id);let e=(0,g.EQ)(t.request_id);x.publish(t,e)}}}sendInternal(e){try{this.restartTTLTimer(),this.socket?(this.addInflightRequest(e),this.augmentDebugPayload(e),this.socket.send(JSON.stringify({...e,origin_id:(0,h.g1)()}))):l.$G.logError("no native websocket while sending message")}catch(e){l.$G.logError("error sending message to native websocket",{error:e})}}raiseErrorCallbacksForPendingRequests(){this.inflightRequests.forEach(e=>{let t=(0,g.EQ)(e.request_id);x.raiseError(t)}),this.inflightRequests=[],this.sendQueue.forEach(e=>{let t=(0,g.EQ)(e.request_id);x.raiseError(t)}),this.sendQueue=[]}addInflightRequest(e){e.request_id&&this.inflightRequests.push(e)}removeInflightRequest(e){this.inflightRequests=this.inflightRequests.filter(t=>t.request_id!==e)}constructor(e){super(e),this.socket=null,this.wsRetryAttemps=0,this.wsRetryTimeout=0,this.heartbeatInterval=0,this.inflightRequests=[],this.sendQueue=[],this.setupWebsocket()}}let H=(e,t,s,r)=>{null==a||a.disconnectWebsocket(),a=r?void 0:new w(e),(s||r)&&(null==i||i.disconnectWebsocket(),i=new S(e,!!r,t))},E=()=>{null==a||a.reconnectWebsocket()},D=()=>{let e=null!=a?a:i;if(!e)throw l.$G.logError("Trying to use chat socket before it has been initialized"),Error("Chat socket uninitialized");return e};class q extends p{async initialize(e,t){await super.initialize(e,t),this.setupWebsocket()}replaceOrRemoveDummyTurn(e,t){let s=this.turns.findIndex(t=>t.primary_candidate_id===_.gn&&t.turn_key.turn_id==="".concat(e,"_").concat(_.gn));return -1!=s&&(t?this.turns[s]=t:this.turns.splice(s,1),!0)}removeAllTypingTurns(){this.typingIndicatorMessaages.forEach(e=>clearTimeout(e.errorTimeout)),this.typingIndicatorMessaages=[]}removeTypingTurn(e,t){if(e){let s=this.typingIndicatorMessaages.findIndex(s=>s.primary_candidate_id===_.vF&&(s.author.author_id===e.author.author_id||s.turn_key.turn_id==="".concat(t,"_").concat(_.vF)));s>-1&&clearTimeout(this.typingIndicatorMessaages.splice(s,1)[0].errorTimeout)}}removeTurn(e){let t=this.turns.findIndex(t=>t.turn_key.turn_id===e);t>-1&&this.turns.splice(t,1)}setupWebsocket(){x.subscribe(this.instanceID,this.onMessageReceived,this.onMessageError)}async deleteMessages(e,t){var s;let a={command:k.OY.remove_turns,request_id:this.buildRequestId(),payload:{chat_id:null===(s=this.chatHistory)||void 0===s?void 0:s.chat_id,turn_ids:e}};this.deleteCallback=t,this.sendSocketMessage(a)}async editMessage(e,t,s){let a={command:k.OY.edit_turn_candidate,request_id:this.buildRequestId(),payload:{turn_key:e,current_candidate_id:t,new_candidate_raw_content:s}};this.lastEditRequestId=a.request_id,this.lastEditTurnId=a.payload.turn_key.turn_id,this.sendSocketMessage(a)}setTurnPin(e,t){let s={command:k.OY.set_turn_pin,request_id:this.buildRequestId(),payload:{turn_key:e,is_pinned:t}};this.lastPinRequestId=s.request_id,this.lastPinTurnId=s.payload.turn_key.turn_id,this.sendSocketMessage(s);let a=this.turns.findIndex(e=>e.turn_key.turn_id===this.lastPinTurnId);a>-1&&(this.turns[a].is_pinned=t)}createNewChat(){var e,t;let s={command:k.OY.create_chat,request_id:this.buildRequestId(),payload:{chat:{chat_id:(0,c.Z)(),creator_id:null===(e=this.user.user)||void 0===e?void 0:e.id.toString(),visibility:k.I9.private,character_id:null===(t=this.charData)||void 0===t?void 0:t.external_id,type:k.MW.direct},with_greeting:!0}};this.turns=[],this.publishChatMessages(),this.sendSocketMessage(s)}publishChatMessages(){var e,t,s;((null===(e=this.charData)||void 0===e?void 0:e.avatar_file_name)||(null===(s=this.user.user)||void 0===s?void 0:null===(t=s.account)||void 0===t?void 0:t.avatar_file_name))&&this.turns.map(e=>{var t,s,a;!e.author.is_human&&!e.author.avatar_url&&(null===(t=this.charData)||void 0===t?void 0:t.avatar_file_name)&&(e.author.avatar_url=this.charData.avatar_file_name),e.author.is_human&&!e.author.avatar_url&&(null===(a=this.user.user)||void 0===a?void 0:null===(s=a.account)||void 0===s?void 0:s.avatar_file_name)&&(e.author.avatar_url=this.user.user.account.avatar_file_name)}),super.publishChatMessages([...this.typingIndicatorMessaages,...this.turns])}async fetchInitialData(e,t,s,a){try{var i,r,n,d;if(this.getStatus()!==_.HH.none)return;if(this.setStatus(_.HH.fetchingHistory),!this.charData){let t=await m.fetchCharacterInfo(e);t&&(this.charData=t.data.character)}if(!(null===(i=this.charData)||void 0===i?void 0:i.external_id))throw Error("Failed to fetch character info for websocket");if(s)this.createNewChat();else if(null!=t){let e=await M.m.fetchChat(t);if((null==e?void 0:e.data.chat)!=null)this.chatHistory=null==e?void 0:e.data.chat;else throw Error("expected a valid chat response from the server")}else{let e=await M.m.fetchRecentChat(this.charData.external_id);(null!==(d=null==e?void 0:null===(n=e.data)||void 0===n?void 0:null===(r=n.chats)||void 0===r?void 0:r.length)&&void 0!==d?d:0)>0?this.chatHistory=e.data.chats[0]:this.createNewChat()}null!=this.chatHistory&&await this.fetchMessageHistory(this.chatHistory.chat_id,void 0,a?{candidate_filter:"all"}:void 0)}catch(s){l.$G.logError("Failed to fetch initial chat data",{error:s}),this.onChatEventCallback(_.qN.unrecoverable_error,{comment:"failed to fetch initial chat data",external_id:e,history_external_id:t,event_time:new Date().getTime()}),this.setStatus(_.HH.dead)}}async fetchMessageHistory(e,t,s){var a,i,r,n,d,u,o;if(!this.chatHistory){this.onChatEventCallback(_.qN.unrecoverable_error,{comment:"chat history doesnt exist",external_id:this.external_id,event_time:new Date().getTime()}),this.setStatus(_.HH.dead);return}if(this.getStatus()===_.HH.fetchMessages)return;let h=null===(a=this.chatHistory)||void 0===a?void 0:a.chat_id,c=null!=s?s:{},m=!1;this.setStatus(_.HH.fetchMessages),t&&(this.nextToken=void 0),this.nextToken&&(c.next_token=this.nextToken,m=!0);try{let e=await M.m.fetchTurns(h,c);this.nextToken=null===(r=e.data)||void 0===r?void 0:null===(i=r.meta)||void 0===i?void 0:i.next_token,this.has_more=!!this.nextToken;let t=(0,g.cE)(null!==(u=null===(n=e.data)||void 0===n?void 0:n.turns)&&void 0!==u?u:[]);m?this.turns=[...this.turns,...t]:(this.turns=[...t],this.updatePrimaryCandidateMapForTurn(this.turns[0])),this.publishChatMessages(),(null===(d=this.chatHistory)||void 0===d?void 0:d.chat_id)&&M.m.resurrectChat(null===(o=this.chatHistory)||void 0===o?void 0:o.chat_id).catch(e=>l.$G.logError("Failed to resurrect chat",{error:e})),this.setStatus(_.HH.none)}catch(e){l.$G.logError("Failed to get chat instance message history",{error:e}),this.onChatEventCallback(_.qN.unrecoverable_error,{comment:"failed to list turns",external_id:this.external_id,event_time:new Date().getTime()}),this.setStatus(_.HH.dead)}}resetFeedbackLabels(e){let t=Object.fromEntries(Object.values(k.KW).map(e=>[e,0]));this.lastGenerateMetadata={turnKey:e,feedbackMap:t},this.stagedFeedbackMap={}}stageFeedbackLabel(e,t){this.stagedFeedbackMap[e]=t}commitFeedbackLabels(){if(!this.lastGenerateMetadata)return;let e=Object.fromEntries(Object.values(k.KW).map(e=>{var t;return[e,this.stagedFeedbackMap[e]||(null===(t=this.lastGenerateMetadata)||void 0===t?void 0:t.feedbackMap[e])?1:0]}));this.lastGenerateMetadata={...this.lastGenerateMetadata,feedbackMap:e},this.stagedFeedbackMap={}}generateCandidate(e){var t,s,a,i,n;if(0===this.turns.length){l.$G.logError("No turns to generate candidate for");return}let d=this.turns[0].turn_key;(d.turn_id===(null===(t=this.lastGenerateMetadata)||void 0===t?void 0:t.turnKey.turn_id)||d.chat_id===(null===(s=this.lastGenerateMetadata)||void 0===s?void 0:s.turnKey.chat_id))&&(null===(a=this.lastGenerateMetadata)||void 0===a?void 0:a.feedbackMap)?this.commitFeedbackLabels():this.resetFeedbackLabels(d);let u={command:k.OY.generate_turn_candidate,request_id:this.buildRequestId(),payload:{tts_enabled:null!=e&&e,selected_language:null!=r?r:"",character_id:null===(i=this.charData)||void 0===i?void 0:i.external_id,user_name:this.user.name,turn_key:{turn_id:d.turn_id,chat_id:d.chat_id},previous_annotations:null===(n=this.lastGenerateMetadata)||void 0===n?void 0:n.feedbackMap}};this.turns[0].state="STATE_INFLIGHT",this.sendSocketMessage(u)}createTurn(e,t){var s,a,i,r,n,d,u,l,o;let h=(0,c.Z)(),_=(0,c.Z)(),m={turn_id:h,chat_id:null!==(d=null===(s=this.chatHistory)||void 0===s?void 0:s.chat_id)&&void 0!==d?d:""},g=t?{author_id:null!==(u=null===(a=this.charData)||void 0===a?void 0:a.external_id)&&void 0!==u?u:"",is_human:!1,name:null!==(l=null===(i=this.charData)||void 0===i?void 0:i.name)&&void 0!==l?l:""}:{author_id:null!==(o=null===(r=this.user.user)||void 0===r?void 0:r.id.toString())&&void 0!==o?o:"",is_human:!0,name:this.user.name},p={command:k.OY.create_turn,request_id:this.buildRequestId(),payload:{character_id:null===(n=this.charData)||void 0===n?void 0:n.external_id,user_name:this.user.name,turn:{turn_key:m,author:g,candidates:[{candidate_id:_,raw_content:e}],primary_candidate_id:_}}};e&&this.addDummyMessage(e,p.request_id,g),this.publishChatMessages(),this.sendSocketMessage(p),this.resetFeedbackLabels(m)}_sendSocketMessage(e,t){var s,a,i,n,d,u,l,o,h,_,m,g,p,v;let b=null===(s=this.turns[0])||void 0===s?void 0:s.turn_key;b&&b.turn_id!==(null===(a=this.lastGenerateMetadata)||void 0===a?void 0:a.turnKey.turn_id)&&b.chat_id!==(null===(i=this.lastGenerateMetadata)||void 0===i?void 0:i.turnKey.chat_id)?this.resetFeedbackLabels(b):this.commitFeedbackLabels();let y=(0,c.Z)(),f=(0,c.Z)(),C={turn_id:y,chat_id:null!==(m=null===(n=this.chatHistory)||void 0===n?void 0:n.chat_id)&&void 0!==m?m:""},M={author_id:null!==(g=null===(d=this.user.user)||void 0===d?void 0:d.id.toString())&&void 0!==g?g:"",is_human:!0,name:this.user.name},I={command:k.OY.create_and_generate_turn,request_id:this.buildRequestId(),payload:{num_candidates:1,tts_enabled:null!=t&&t,selected_language:null!=r?r:"",character_id:null===(u=this.charData)||void 0===u?void 0:u.external_id,user_name:this.user.name,turn:{turn_key:C,author:M,candidates:[{candidate_id:f,raw_content:e}],primary_candidate_id:f},previous_annotations:null===(l=this.lastGenerateMetadata)||void 0===l?void 0:l.feedbackMap}};e&&this.addDummyMessage(e,I.request_id,M),this.addTypingMessage(null!==(p=null===(o=this.charData)||void 0===o?void 0:o.external_id)&&void 0!==p?p:"",null!==(v=null===(h=this.charData)||void 0===h?void 0:h.name)&&void 0!==v?v:"",!1,I.request_id,null===(_=this.charData)||void 0===_?void 0:_.avatar_file_name),this.publishChatMessages(),this.sendSocketMessage(I),this.resetFeedbackLabels(C)}sendChatMessage(e){switch(e.type){case"create":this.createTurn(e.message,e.on_behalf_of_character);break;case"generate_candidate":this.generateCandidate(e.ttsEnabled);break;case"stage_feedback_label":this.stageFeedbackLabel(e.feedbackLabel,e.addOrRemove);break;case"abort":this.abortCandidateGeneration();break;case"create_and_generate":this._sendSocketMessage(e.message,e.ttsEnabled);break;case"edit_turn_candidate":this.editMessage(e.turnKey,e.candidateId,e.newRawContent);break;case"set_turn_pin":this.setTurnPin(e.turnKey,e.isPinned)}}updatePrimaryCandidateMap(e,t){var s;super.updatePrimaryCandidateMap(e,t);let a=null===(s=this.turns[0])||void 0===s?void 0:s.turn_key.turn_id;a&&this.setPrimaryCandidateOfTurn(a,t)}updatePrimaryCandidateMapForTurn(e){if(e&&e.candidates.length>1){let t=e.primary_candidate_id,s=e.candidates.findIndex(e=>e.candidate_id===t);s>-1&&super.updatePrimaryCandidateMap(e.turn_key.turn_id,s)}}setPrimaryCandidateOfTurn(e,t){let s=this.turns.find(t=>t.turn_key.turn_id===e);if(!s)return;let a=s.candidates[t];if(!a)return;let i=a.candidate_id;i&&i!==_.vF&&i!==_.gn&&a.is_final&&(s.primary_candidate_id=i,this.sendSocketMessage({command:k.OY.update_primary_candidate,payload:{candidate_id:i,turn_key:s.turn_key}}))}abortCandidateGeneration(){if(this.lastRequestId){let e={command:k.OY.abort_generation,request_id:this.lastRequestId};this.abortRequestId=this.lastRequestId,this.lastRequestId=null,this.sendSocketMessage(e)}}sendSocketMessage(e){D().send(e)}cleanup(){super.cleanup(),x.unsubscribe(this.instanceID)}addSelfHarmSystemTurn(){var e,t;if(!(this.turns[0].candidates[0].raw_content!==_.Aj))return;let s=(0,c.Z)(),a={turn_key:{turn_id:(0,c.Z)(),chat_id:null!==(t=null===(e=this.chatHistory)||void 0===e?void 0:e.chat_id)&&void 0!==t?t:""},author:{author_id:_.B8,is_human:!1,name:_.B8,avatar_url:""},candidates:[{candidate_id:s,raw_content:_.Aj,create_time:new Date().toISOString(),fresh:!1,is_final:!0}],create_time:new Date().toISOString(),last_update_time:new Date().toISOString(),state:"STATE_INFLIGHT",primary_candidate_id:s,clientSystemMessage:{messageType:y.lo.self_harm_detected,message:""}};this.turns=[a,...this.turns]}addDummyMessage(e,t,s){var a,i;this.hasTypingMessage(s.author_id.toString())||(this.turns=[{turn_key:{turn_id:"".concat(t,"_").concat(_.gn),chat_id:null!==(i=null===(a=this.chatHistory)||void 0===a?void 0:a.chat_id)&&void 0!==i?i:""},author:s,candidates:[{candidate_id:_.gn,raw_content:e,create_time:new Date().toISOString(),fresh:!1,is_final:!0}],create_time:new Date().toISOString(),last_update_time:new Date().toISOString(),state:"STATE_INFLIGHT",primary_candidate_id:_.gn},...this.turns])}addTypingMessage(e,t,s,a,i){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"typing",n=this.typingIndicatorMessaages.findIndex(t=>t.primary_candidate_id===_.vF&&t.author.author_id===e);if(n>-1){let e=this.typingIndicatorMessaages[n];this.resetTypingTurnTimeout(e,a)}else{var d,u;if((null===(d=this.user.user)||void 0===d?void 0:d.id.toString())&&this.hasTypingMessage(null===(u=this.user.user)||void 0===u?void 0:u.id.toString()))return;this.addTypingTurn(e,t,s,a,i,r)}}createNewTypingTurn(e,t,s,a,i){var r,n;let d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"typing",u={turn_key:{turn_id:"".concat(a,"_").concat(_.vF),chat_id:null!==(n=null===(r=this.chatHistory)||void 0===r?void 0:r.chat_id)&&void 0!==n?n:""},author:{author_id:e,is_human:s,name:t,avatar_url:null!=i?i:""},candidates:[{candidate_id:_.vF,raw_content:"",create_time:new Date().toISOString(),fresh:!0,is_final:!0}],create_time:new Date().toISOString(),last_update_time:s?new Date().toISOString():new Date(new Date().getTime()+1e4).toISOString(),state:"STATE_INFLIGHT",primary_candidate_id:_.vF,errorTimeout:-1,type:d};return this.setTypingTurnTimeout(u,a),u}resetTypingTurnTimeout(e,t){clearTimeout(e.errorTimeout),this.setTypingTurnTimeout(e,t),e.last_update_time=new Date().toISOString()}setTypingTurnTimeout(e,t){"processing"===e.type&&(e.errorTimeout=setTimeout(()=>this.onLongProcesingIndicator(e,t),f.QC))}addTypingTurn(e,t,s,a,i){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"typing",n=this.createNewTypingTurn(e,t,s,a,i,r);this.typingIndicatorMessaages=[n,...this.typingIndicatorMessaages]}onLongProcesingIndicator(e,t){this.removeTypingTurn(e,t),this.publishChatMessages()}constructor(e,t,s,a,i,r){super(e,t,s,a,i,r),this.lastRequestId=null,this.abortRequestId=null,this.lastEditRequestId=null,this.lastEditTurnId=null,this.lastPinRequestId=null,this.lastPinTurnId=null,this.stagedFeedbackMap={},this.lastGenerateMetadata=null,this.typingIndicatorMessaages=[],this.onMessageReceived=e=>{e.request_id&&(this.lastRequestId=e.request_id);let t=e.request_id===this.lastEditRequestId,s=t&&e.command===k.zd.update_turn?e.turn.candidates.findIndex(t=>t.candidate_id===e.turn.primary_candidate_id):-1,a=e.request_id===this.lastPinRequestId,i=a&&this.lastPinTurnId?this.turns.findIndex(e=>e.turn_key.turn_id===this.lastPinTurnId):-1;switch(e.command){case k.zd.add_turn:this.replaceOrRemoveDummyTurn(e.request_id,e.turn)?this.publishChatMessages():(this.removeTypingTurn(e.turn,e.request_id),this.appendTurn(e.turn));break;case k.zd.update_turn:a&&i>-1?this.updateCandidate(this.turns[i],this.turns[i].turn_key.turn_id,e.request_id):t&&-1!==s?this.updateCandidate(e.turn,e.turn.turn_key.turn_id,e.request_id,{editedCandidate:e.turn.candidates[s]}):this.updateCandidate(e.turn,e.turn.turn_key.turn_id,e.request_id);break;case k.zd.create_chat_response:this.chatHistory=e.chat,this.fetchMessageHistory();break;case k.zd.neo_error:if(l.$G.logError("Neo error from websocket: ".concat(e.error_code),{extra:{data:e}}),e.error_code===k.dw.MultiGeneration.errorCode&&e.sub_code===k.dw.MultiGeneration.subCode);else if(e.comment===_.Aj)this.removeAllTypingTurns(),this.replaceOrRemoveDummyTurn(e.request_id),this.onChatEventCallback(_.qN.self_harm_detected),this.addSelfHarmSystemTurn(),this.publishChatMessages();else{let s=t?this.turns.findIndex(e=>e.turn_key.turn_id===this.lastEditTurnId):-1;t&&-1!==s?this.onMessageError([s]):(Number(e.error_code)===k.dw.TooManyPins.errorCode&&Number(e.sub_code)===k.dw.TooManyPins.subCode&&a&&i>-1&&(this.turns[i].is_pinned=!1),this.onMessageError()),this.onChatEventCallback(_.qN.websocket_error,{comment:e.comment,error_code:e.error_code,sub_code:e.sub_code,event_time:new Date().getTime()})}break;case k.zd.remove_turns_response:this.useDeleteCallback(!0),this.fetchMessageHistory(void 0,!0);break;case k.zd.remove_turn:this.removeTurn(e.turn_key.turn_id),this.useDeleteCallback(!0),this.publishChatMessages();break;case k.zd.update_mu_room_response:this.onChatEventCallback(_.qN.updated,{updates:e});break;case k.zd.delete_mu_room:this.onChatEventCallback(_.qN.deleted,{id:e.id});break;case k.zd.mu_state_update:var r,n;(null===(r=e.payload)||void 0===r?void 0:r.type)&&e.payload.participant!==(null===(n=this.user.user)||void 0===n?void 0:n.id.toString())&&(this.addTypingMessage(e.payload.participant,e.payload.participantName,e.payload.isHuman,e.request_id,e.payload.participantAvatar,e.payload.type),this.publishChatMessages())}},this.onMessageError=e=>{for(let e=0;e<this.turns.length;e++)if("STATE_INFLIGHT"===this.turns[e].state)this.turns[e].state="STATE_ERROR",this.removeAllTypingTurns();else break;for(let t of null!=e?e:[])this.turns[t].state="STATE_ERROR";this.publishChatMessages()},this.hasTypingMessage=e=>this.turns.findIndex(t=>t.author.author_id===e&&t.primary_candidate_id===_.vF)>-1,this.deleteCallback=()=>{},this.useDeleteCallback=e=>{this.deleteCallback(e),this.deleteCallback=()=>{}}}}class R extends q{setupTypingIndicatorInterval(){this.typingInterval=setInterval(()=>{let e=!1;for(let t=this.typingIndicatorMessaages.length-1;t>=0;t--){let s=this.typingIndicatorMessaages[t];s.primary_candidate_id===_.vF&&new Date().getTime()-new Date(s.last_update_time).getTime()>f.fw&&(this.removeTypingTurn(s),e=!0)}e&&this.publishChatMessages()},3e3)}isInitialized(){return!0}setupWebsocket(){x.subscribe(this.instanceID,this.onMessageReceived,this.onMessageError,()=>{this.fetchMessageHistory()}),i.reconnectWebsocket(),i.subscribeToRoom(this.external_id,this.instanceID)}async fetchInitialData(){this.getStatus()===_.HH.none&&(this.setStatus(_.HH.fetchingHistory),this.fetchMessageHistory())}async fetchMessageHistory(){if(this.getStatus()===_.HH.fetchMessages)return;this.setStatus(_.HH.fetchMessages);let e={},t=!1;this.nextToken&&(e.next_token=this.nextToken,t=!0);try{var s,a,i,r,n,d;let u=await M.m.fetchTurns(this.external_id,e);this.nextToken=null===(a=u.data)||void 0===a?void 0:null===(s=a.meta)||void 0===s?void 0:s.next_token,this.has_more=(null===(r=u.data)||void 0===r?void 0:null===(i=r.turns)||void 0===i?void 0:i.length)>0;let l=null!==(d=null===(n=u.data)||void 0===n?void 0:n.turns)&&void 0!==d?d:[];l.forEach(e=>{e.candidates.sort((e,t)=>new Date(e.create_time)>new Date(t.create_time)?1:-1)}),t?this.turns=[...this.turns,...l]:this.turns=[...l],this.publishChatMessages(),this.setStatus(_.HH.none)}catch(e){l.$G.logError("Failed to get room message history",{error:e}),this.onChatEventCallback(_.qN.unrecoverable_error,{comment:"failed to get room",external_id:this.external_id,event_time:new Date().getTime()}),this.setStatus(_.HH.dead)}}async deleteMessages(e,t){if(0===e.length)return;e.length;let s={command:k.OY.remove_turn,request_id:this.buildRequestId(),payload:{turn_key:{chat_id:this.external_id,turn_id:e[0]}}};this.deleteCallback=t,this.sendSocketMessage(s)}sendChatMessage(e){switch(e.type){case"create":this.sendCreateCommand({messageText:e.message,context_reset:e.context_reset,smart_reply:e.smart_reply});break;case"generate":this.sendGenerateCommand(e.characterId,e.characterName);break;case"generate_room_candidate":this.sendGenerateRoomCandidateCommand(e.turnId,e.characterId);break;case"smart_turn":this.sendSmartGenerateTurn(e.smart_reply);break;case"state_update":this.sendStateUpdateCommand(e);break;case"edit_turn_candidate":this.editMessage(e.turnKey,e.candidateId,e.newRawContent)}}subscribe(e){super.subscribe(e),1===this.subscriberCallbacks.length&&this.setupWebsocket()}unsubscribe(e){super.unsubscribe(e),0===this.subscriberCallbacks.length&&this.cleanup()}cleanup(){clearInterval(this.typingInterval),x.unsubscribe(this.instanceID),i.unsubscribeFromRoom(this.external_id)}sendCreateCommand(e){var t,s;let a=(0,c.Z)(),r={author_id:null!==(s=null===(t=this.user.user)||void 0===t?void 0:t.id.toString())&&void 0!==s?s:"",is_human:!0,name:this.user.name},n={command:e.smart_reply?k.OY.create_and_generate_turn:k.OY.create_turn,request_id:this.buildRequestId(),payload:{smart_reply:e.smart_reply,chat_type:k.Y6.TYPE_MU_ROOM,num_candidates:1,user_name:this.user.name,turn:{context_reset:e.context_reset,turn_key:{turn_id:a,chat_id:this.external_id},author:r,candidates:[{candidate_id:a,raw_content:e.messageText}],primary_candidate_id:a}}};e.messageText&&this.addDummyMessage(e.messageText,n.request_id,r),this.publishChatMessages(),i.send(n)}sendGenerateCommand(e,t){let s={command:k.OY.generate_turn,request_id:this.buildRequestId(),payload:{chat_type:k.Y6.TYPE_MU_ROOM,character_id:e,chat_id:this.external_id}};this.publishChatMessages(),i.send(s)}sendGenerateRoomCandidateCommand(e,t){let s={command:k.OY.generate_turn_candidate,request_id:this.buildRequestId(),payload:{chat_type:k.Y6.TYPE_MU_ROOM,character_id:t,user_name:this.user.name,turn_key:{turn_id:e,chat_id:this.external_id}}},a=this.turns.findIndex(t=>t.turn_key.turn_id===e);a>-1&&(this.turns[a].state="STATE_INFLIGHT",this.publishChatMessages()),i.send(s)}sendSmartGenerateTurn(e){var t;let s={command:k.OY.generate_turn,request_id:this.buildRequestId(),payload:{chat_type:k.Y6.TYPE_MU_ROOM,chat_id:this.external_id,user_name:null===(t=this.user.user)||void 0===t?void 0:t.username,smart_reply:e,smart_reply_delay:0}};this.publishChatMessages(),i.send(s)}sendStateUpdateCommand(e){let t={command:k.OY.mu_state_update,request_id:this.buildRequestId(),payload:{chat_type:k.Y6.TYPE_MU_ROOM,author:e.author,participant:e.participant,type:e.updateType,participantName:e.participantName,participantAvatar:e.participantAvatar,isHuman:e.isHuman}};i.send(t,this.external_id)}constructor(e,t,s,a,i){super(e,t,s,a,i),this.typingInterval=0,this.setupTypingIndicatorInterval()}}var N=s(65332),O=s(84377);let P=()=>console.error("Context has not been initialized"),U=u.createContext({subscribe:(e,t,s,a)=>(P(),{currentStatus:_.HH.none,unsubscribe:()=>{}}),publish:(e,t)=>P,refresh:(e,t,s)=>P,refreshUser:e=>P,subscribeChatEvents:(e,t)=>P,removeUnfocusedInstances:e=>P,removeClientMessages:(e,t)=>P,deleteMessages:(e,t,s)=>P,deleteInstance:e=>P,getChatMessages:e=>Promise.resolve(null),setupAxios:e=>P,updatePrimaryCandidateMap:(e,t,s)=>P,setPrimaryCandidateOfTurn:(e,t,s)=>P,reconnect:()=>P,updateConfiguration:()=>P,chatManagerInitialized:!1,isRoom:!1}),F=e=>{r=e},G=e=>{let{children:t,getAxiosInstance:s,neoEnabled:a,originId:i,userId:r,useCentrifuge:n,useCentrifugeByDefault:d,errorLogger:c,isRoom:m}=e,g=u.useRef({}),[p,v]=u.useState(!1),b=(0,u.useRef)({}),y=(0,u.useRef)(!1);y.current||((0,o.C)(s),y.current=!0),(0,u.useEffect)(()=>{(0,h.qA)(i)},[i]),(0,u.useEffect)(()=>{(0,l.bL)(c)},[c]),(0,u.useEffect)(()=>()=>{for(let e in g.current)g.current[e]&&M(e)},[]);let f=(0,u.useCallback)((e,t)=>{if(b.current[e])for(let s in b.current[e])b.current[e][s]&&b.current[e][s](e,t)},[]);(0,u.useEffect)(()=>{(0,o.C)(s),a&&(H(f,r,n,d),v(!0))},[f,a,s,r,n,d]);let k=(0,u.useCallback)(e=>{let{neoHost:t,selectedLanguage:s}=e;t&&((0,h.e3)(t),a&&H(f,r,n,d)),F(s)},[r,n,d,a]),C=(0,u.useCallback)((e,t)=>(b.current[e]||(b.current[e]=[]),b.current[e].push(t),()=>{b.current[e]=b.current[e].filter(e=>e!==t)}),[]),M=(0,u.useCallback)(e=>{g.current[e]&&(g.current[e].cleanup(),delete g.current[e])},[]),I=(0,u.useCallback)((e,t,s,a)=>{var i,r,n,d;let u=null==a?void 0:a.externalHistoryId,l=null==a?void 0:a.forceRefresh;if(g.current[e]){if(u&&(null===(i=g.current[e])||void 0===i?void 0:i.chatHistory)&&(null===(n=g.current[e])||void 0===n?void 0:null===(r=n.chatHistory)||void 0===r?void 0:r.chat_id)!==u||l||(null===(d=g.current[e])||void 0===d?void 0:d.getStatus())===_.HH.dead){let t=g.current[e].subscriberCallbacks;M(e),g.current[e]=A(s,e,O.a,f,a),g.current[e].subscriberCallbacks=t}}else g.current[e]=A(s,e,O.a,f,a);return g.current[e].subscribe(t),g.current[e].publishChatMessages(),{currentStatus:g.current[e].getStatus(),unsubscribe:()=>{var s;null===(s=g.current[e])||void 0===s||s.unsubscribe(t)}}},[M]),T=(0,u.useCallback)(e=>{for(let t of Object.keys(g.current))g.current[t].setUser(e),g.current[t].refreshHistory()},[]),x=(0,u.useCallback)((e,t,s)=>{if(g.current[e]){if(t&&(g.current[e].turns=[],g.current[e].messages=[],g.current[e].publishChatMessages()),s){let s=g.current[e].subscriberCallbacks,i=g.current[e].onChatEventCallback,r=t&&a?_.Em.Neo:g.current[e].serviceType;M(e),g.current[e]=A(r,e,O.a,f,{newHistory:t}),g.current[e].subscriberCallbacks=s,g.current[e].onChatEventCallback=i,g.current[e].publishChatMessages()}else g.current[e].refreshHistory(t)}},[M]),S=(0,u.useCallback)(e=>{for(let t in g.current)g.current[t]&&t!==e&&M(t)},[M]),w=(0,u.useCallback)((e,t)=>{g.current[e]&&g.current[e].sendChatMessage(t),N.M.fire()},[]),D=(0,u.useCallback)((e,t,s)=>{g.current[e]&&g.current[e].updatePrimaryCandidateMap(t,s)},[]),q=(0,u.useCallback)((e,t,s)=>{g.current[e]&&g.current[e].setPrimaryCandidateOfTurn(t,s)},[]),R=(0,u.useCallback)((e,t)=>{g.current[e]&&g.current[e].removeClientMessages(t)},[]),P=(0,u.useCallback)((e,t,s)=>{g.current[e]&&g.current[e].deleteMessages(t,s)},[]),G=(0,u.useCallback)(async e=>{var t,s;return(null===(t=g.current[e])||void 0===t?void 0:t.isInitialized())?(await g.current[e].fetchMessageHistory(),!!(null===(s=g.current[e])||void 0===s?void 0:s.has_more)):null},[]);return u.createElement(U.Provider,{value:{subscribe:I,publish:w,refresh:x,refreshUser:T,subscribeChatEvents:C,removeUnfocusedInstances:S,deleteMessages:P,removeClientMessages:R,getChatMessages:G,setupAxios:o.C,updatePrimaryCandidateMap:D,setPrimaryCandidateOfTurn:q,reconnect:E,updateConfiguration:k,deleteInstance:M,chatManagerInitialized:p,isRoom:!!m},children:t})},L=()=>(0,u.useContext)(U),A=(e,t,s,a,i)=>{let r;switch(e){case _.Em.Legacy:r=new b(e,t,s,a,null==i?void 0:i.externalHistoryId,null==i?void 0:i.character);break;case _.Em.Neo:r=new q(e,t,s,a,null==i?void 0:i.externalHistoryId,null==i?void 0:i.character);break;case _.Em.Room:r=new R(e,t,s,a,null==i?void 0:i.externalHistoryId)}return null==r||r.initialize(null==i?void 0:i.newHistory,null==i?void 0:i.fetchAllCandidates),r}},5813:function(e,t,s){var a,i,r,n,d,u,l,o;s.d(t,{$3:function(){return n},Aj:function(){return m},B8:function(){return g},Em:function(){return r},HH:function(){return i},Nm:function(){return c},gn:function(){return h},qN:function(){return a},vF:function(){return _}}),(d=a||(a={}))[d.messages=0]="messages",d[d.error=1]="error",d[d.filter=2]="filter",d[d.abort=3]="abort",d[d.receive_fail=4]="receive_fail",d[d.message_finished=5]="message_finished",d[d.message_edited=6]="message_edited",d[d.websocket_status=7]="websocket_status",d[d.websocket_error=8]="websocket_error",d[d.unrecoverable_error=9]="unrecoverable_error",d[d.updated=10]="updated",d[d.deleted=11]="deleted",d[d.state_update=12]="state_update",d[d.self_harm_detected=13]="self_harm_detected",(u=i||(i={})).none="none",u.sending="sending",u.fetchingHistory="fetchingHistory",u.fetchMessages="fetchMessages",u.cancelling="cancelling",u.dead="dead";let h="dummy_msg",c="user_msg",_="typing_msg",m="Self harm message detected",g="client_system";(l=r||(r={})).Legacy="legacy",l.Neo="neo",l.Room="room",(o=n||(n={})).open="open",o.closed="closed",o.error="error",o.reconnecting="reconnecting"},2236:function(e,t,s){s.d(t,{R:function(){return a.Rv},m:function(){return a.mx}});var a=s(41133)}}]);