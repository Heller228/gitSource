"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2493],{82678:function(e,t,n){n.d(t,{qX:function(){return G}});var s,i,r,o,c,a,h,l,u,_,d,p,b,f,m,g,v={exports:{}},y="object"==typeof Reflect?Reflect:null,T=y&&"function"==typeof y.apply?y.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};u=y&&"function"==typeof y.ownKeys?y.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var S=Number.isNaN||function(e){return e!=e};function C(){C.init.call(this)}v.exports=C,v.exports.once=function(e,t){return new Promise(function(n,s){function i(n){e.removeListener(t,r),s(n)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}D(e,t,r,{once:!0}),"error"!==t&&"function"==typeof e.on&&D(e,"error",i,{once:!0})})},C.EventEmitter=C,C.prototype._events=void 0,C.prototype._eventsCount=0,C.prototype._maxListeners=void 0;var w=10;function k(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function E(e){return void 0===e._maxListeners?C.defaultMaxListeners:e._maxListeners}function P(e,t,n,s){if(k(n),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),o=r[t]),void 0===o)o=r[t]=n,++e._eventsCount;else if("function"==typeof o?o=r[t]=s?[n,o]:[o,n]:s?o.unshift(n):o.push(n),(i=E(e))>0&&o.length>i&&!o.warned){o.warned=!0;var i,r,o,c=Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,console&&console.warn&&console.warn(c)}return e}function R(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function x(e,t,n){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=R.bind(s);return i.listener=n,s.wrapFn=i,i}function O(e,t,n){var s=e._events;if(void 0===s)return[];var i=s[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):L(i,i.length)}function j(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function L(e,t){for(var n=Array(t),s=0;s<t;++s)n[s]=e[s];return n}function D(e,t,n,s){if("function"==typeof e.on)s.once?e.once(t,n):e.on(t,n);else if("function"==typeof e.addEventListener)e.addEventListener(t,function i(r){s.once&&e.removeEventListener(t,i),n(r)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(C,"defaultMaxListeners",{enumerable:!0,get:function(){return w},set:function(e){if("number"!=typeof e||e<0||S(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");w=e}}),C.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},C.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||S(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},C.prototype.getMaxListeners=function(){return E(this)},C.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var r,o=Error("Unhandled error."+(r?" ("+r.message+")":""));throw o.context=r,o}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)T(c,this,t);else for(var a=c.length,h=L(c,a),n=0;n<a;++n)T(h[n],this,t);return!0},C.prototype.addListener=function(e,t){return P(this,e,t,!1)},C.prototype.on=C.prototype.addListener,C.prototype.prependListener=function(e,t){return P(this,e,t,!0)},C.prototype.once=function(e,t){return k(t),this.on(e,x(this,e,t)),this},C.prototype.prependOnceListener=function(e,t){return k(t),this.prependListener(e,x(this,e,t)),this},C.prototype.removeListener=function(e,t){var n,s,i,r,o;if(k(t),void 0===(s=this._events)||void 0===(n=s[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,r=n.length-1;r>=0;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,i=r;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(s[e]=n[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},C.prototype.off=C.prototype.removeListener,C.prototype.removeAllListeners=function(e){var t,n,s;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0==arguments.length){var i,r=Object.keys(n);for(s=0;s<r.length;++s)"removeListener"!==(i=r[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},C.prototype.listeners=function(e){return O(this,e,!0)},C.prototype.rawListeners=function(e){return O(this,e,!1)},C.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):j.call(e,t)},C.prototype.listenerCount=j,C.prototype.eventNames=function(){return this._eventsCount>0?u(this._events):[]};var U=(s=v.exports)&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;function I(e){return null!=e&&"function"==typeof e}function z(e,t,n){e>31&&(e=31);let s=Math.floor(Math.random()*(Math.min(n,t*Math.pow(2,e))-0+1)+0);return Math.min(n,t+s)}function A(e){return Math.min(1e3*e,2147483647)}(i=_||(_={}))[i.timeout=1]="timeout",i[i.transportClosed=2]="transportClosed",i[i.clientDisconnected=3]="clientDisconnected",i[i.clientClosed=4]="clientClosed",i[i.clientConnectToken=5]="clientConnectToken",i[i.clientRefreshToken=6]="clientRefreshToken",i[i.subscriptionUnsubscribed=7]="subscriptionUnsubscribed",i[i.subscriptionSubscribeToken=8]="subscriptionSubscribeToken",i[i.subscriptionRefreshToken=9]="subscriptionRefreshToken",i[i.transportWriteError=10]="transportWriteError",i[i.connectionClosed=11]="connectionClosed",i[i.badConfiguration=12]="badConfiguration",(r=d||(d={}))[r.connectCalled=0]="connectCalled",r[r.transportClosed=1]="transportClosed",r[r.noPing=2]="noPing",r[r.subscribeTimeout=3]="subscribeTimeout",r[r.unsubscribeError=4]="unsubscribeError",(o=p||(p={}))[o.disconnectCalled=0]="disconnectCalled",o[o.unauthorized=1]="unauthorized",o[o.badProtocol=2]="badProtocol",o[o.messageSizeLimit=3]="messageSizeLimit",(c=b||(b={}))[c.subscribeCalled=0]="subscribeCalled",c[c.transportClosed=1]="transportClosed",(a=f||(f={}))[a.unsubscribeCalled=0]="unsubscribeCalled",a[a.unauthorized=1]="unauthorized",a[a.clientClosed=2]="clientClosed",(h=m||(m={})).Disconnected="disconnected",h.Connecting="connecting",h.Connected="connected",(l=g||(g={})).Unsubscribed="unsubscribed",l.Subscribing="subscribing",l.Subscribed="subscribed";class M extends U{constructor(e,t,n){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state=g.Unsubscribed,this._centrifuge=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._setOptions(n),this._centrifuge._debugEnabled?(this.on("state",e=>{this._centrifuge._debug("subscription state",t,e.oldState,"->",e.newState)}),this.on("error",e=>{this._centrifuge._debug("subscription error",t,e)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===g.Unsubscribed?Promise.reject({code:_.subscriptionUnsubscribed,message:this.state}):this.state===g.Subscribed?Promise.resolve():new Promise((t,n)=>{let s={resolve:t,reject:n};e&&(s.timeout=setTimeout(function(){n({code:_.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=s})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(b.subscribeCalled,"subscribe called"))}unsubscribe(){this._setUnsubscribed(f.unsubscribeCalled,"unsubscribe called",!0)}publish(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.publish(t.channel,e)})}presence(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presence(e.channel)})}presenceStats(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presenceStats(e.channel)})}history(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:_.subscriptionUnsubscribed,message:this.state}):new Promise((e,t)=>{let n=setTimeout(function(){t({code:_.timeout,message:"timeout"})},this._centrifuge._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return!0===this._recover}_isUnsubscribed(){return this.state===g.Unsubscribed}_isSubscribing(){return this.state===g.Subscribing}_isSubscribed(){return this.state===g.Subscribed}_setState(e){if(this.state!==e){let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return""!==this._token||null!==this._getToken}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),this._setState(g.Subscribed);let t=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();let n=e.publications;if(n&&n.length>0)for(let e in n)n.hasOwnProperty(e)&&this._handlePublication(n[e]);!0===e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),A(e.ttl)))}_setSubscribing(e,t){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(g.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._subscribe(!1,!1))}_subscribe(e,t){if(this._centrifuge._debug("subscribing on",this.channel),this._centrifuge.state!==m.Connected&&!e)return this._centrifuge._debug("delay subscribe on",this.channel,"till connected"),null;let n=this,s={channel:n.channel};return!this._usesToken()||this._token?n._getData?(n._getData(s).then(function(e){n._isSubscribing()&&(n._data=e,n._sendSubscribe(n._token,!1))}),null):n._sendSubscribe(n._token,t):(e||this._getSubscriptionToken().then(function(e){if(n._isSubscribing()){if(!e){n._failUnauthorized();return}n._token=e,n._getData?n._getData(s).then(function(t){n._isSubscribing()&&(n._data=t,n._sendSubscribe(e,!1))}):n._sendSubscribe(e,!1)}}).catch(function(e){if(n._isSubscribing()){if(e instanceof X){n._failUnauthorized();return}n.emit("error",{type:"subscribeToken",channel:n.channel,error:{code:_.subscriptionSubscribeToken,message:void 0!==e?e.toString():""}}),n._scheduleResubscribe()}}),null)}_sendSubscribe(e,t){let n={channel:this.channel};if(e&&(n.token=e),this._data&&(n.data=this._data),this._positioned&&(n.positioned=!0),this._recoverable&&(n.recoverable=!0),this._joinLeave&&(n.join_leave=!0),this._needRecover()){n.recover=!0;let e=this._getOffset();e&&(n.offset=e);let t=this._getEpoch();t&&(n.epoch=t)}let s={subscribe:n};return this._inflight=!0,this._centrifuge._call(s,t).then(e=>{this._inflight=!1;let t=e.reply.subscribe;this._handleSubscribeResponse(t),e.next&&e.next()},e=>{this._inflight=!1,this._handleSubscribeError(e.error),e.next&&e.next()}),s}_handleSubscribeError(e){if(this._isSubscribing()){if(e.code===_.timeout){this._centrifuge._disconnect(d.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,t,n){this._isUnsubscribed()||(this._isSubscribed()&&(n&&this._centrifuge._unsubscribe(this),this._clearSubscribedState()),this._isSubscribing()&&(this._inflight&&n&&this._centrifuge._unsubscribe(this),this._clearSubscribingState()),this._setState(g.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:_.subscriptionUnsubscribed,message:this.state}))}_handlePublication(e){let t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){let t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}_scheduleResubscribe(){let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe(!1,!1)},t)}_subscribeError(e){if(this._isSubscribing()){if(e.code<100||109===e.code||!0===e.temporary){109===e.code&&(this._token="");let t={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===m.Connected&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}}_getResubscribeDelay(){let e=z(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){e&&(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),void 0!==e.minResubscribeDelay&&(this._minResubscribeDelay=e.minResubscribeDelay),void 0!==e.maxResubscribeDelay&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),!0===e.positioned&&(this._positioned=!0),!0===e.recoverable&&(this._recoverable=!0),!0===e.joinLeave&&(this._joinLeave=!0))}_getOffset(){let e=this._offset;return null!==e?e:0}_getEpoch(){let e=this._epoch;return null!==e?e:""}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){null!==this._resubscribeTimeout&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._centrifuge._debug("get subscription token for channel",this.channel);let e={channel:this.channel},t=this._getToken;if(null===t)throw this.emit("error",{type:"configuration",channel:this.channel,error:{code:_.badConfiguration,message:"provide a function to get channel subscription token"}}),new X("");return t(e)}_refresh(){this._clearRefreshTimeout();let e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t){e._failUnauthorized();return}e._token=t;let n={channel:e.channel,token:t};e._centrifuge._call({sub_refresh:n}).then(t=>{let n=t.reply.sub_refresh;e._refreshResponse(n),t.next&&t.next()},t=>{e._refreshError(t.error),t.next&&t.next()})}).catch(function(t){if(t instanceof X){e._failUnauthorized();return}e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:_.subscriptionRefreshToken,message:void 0!==t?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){this._isSubscribed()&&(this._centrifuge._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),!0===e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),A(e.ttl))))}_refreshError(e){this._isSubscribed()&&(e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return z(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(f.unauthorized,"unauthorized",!0)}}class W{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return null!==this.options.sockjs}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class N{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return void 0!==this.options.websocket&&null!==this.options.websocket}initialize(e,t){let n="";"protobuf"===e&&(n="centrifuge-protobuf"),""!==n?this._transport=new this.options.websocket(this.endpoint,n):this._transport=new this.options.websocket(this.endpoint),"protobuf"===e&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class J{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw Error(e.status);return e}_fetchEventTarget(e,t,n){let s=new EventTarget;return(0,e.options.fetch)(t,n).then(e._handleErrors).then(t=>{s.dispatchEvent(new Event("open"));let n="",i=0,r=new Uint8Array,o=t.body.getReader();return new e.options.readableStream({start:t=>(function c(){return o.read().then(({done:o,value:a})=>{if(o){s.dispatchEvent(new Event("close")),t.close();return}try{if("json"===e._protocol)for(n+=e._utf8decoder.decode(a);i<n.length;)if("\n"===n[i]){let e=n.substring(0,i);s.dispatchEvent(new MessageEvent("message",{data:e})),n=n.substring(i+1),i=0}else++i;else{let t=new Uint8Array(r.length+a.length);for(t.set(r),t.set(a,r.length),r=t;;){let t=e.options.decoder.decodeReply(r);if(t.ok){let e=r.slice(0,t.pos);s.dispatchEvent(new MessageEvent("message",{data:e})),r=r.slice(t.pos);continue}break}}}catch(e){s.dispatchEvent(new Event("error",{detail:e})),s.dispatchEvent(new Event("close")),t.close();return}c()}).catch(function(e){s.dispatchEvent(new Event("error",{detail:e})),s.dispatchEvent(new Event("close")),t.close()})})()})}).catch(e=>{s.dispatchEvent(new Event("error",{detail:e})),s.dispatchEvent(new Event("close"))}),s}supported(){return null!==this.options.fetch&&null!==this.options.readableStream&&"undefined"!=typeof TextDecoder&&"undefined"!=typeof AbortController&&"undefined"!=typeof EventTarget&&"undefined"!=typeof Event&&"undefined"!=typeof MessageEvent&&"undefined"!=typeof Error}initialize(e,t,n){this._protocol=e,this._abortController=new AbortController;let s={method:"POST",headers:"json"===e?{Accept:"application/json","Content-Type":"application/json"}:{Accept:"application/octet-stream","Content-Type":"application/octet-stream"},body:n,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal},i=this._fetchEventTarget(this,this.endpoint,s);i.addEventListener("open",()=>{t.onOpen()}),i.addEventListener("error",e=>{this._abortController.abort(),t.onError(e)}),i.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),i.addEventListener("message",e=>{t.onMessage(e.data)})}close(){this._abortController.abort()}send(e,t,n){let s,i;let r={session:t,node:n,data:e};"json"===this._protocol?(s={"Content-Type":"application/json"},i=JSON.stringify(r)):(s={"Content-Type":"application/octet-stream"},i=this.options.encoder.encodeEmulationRequest(r));let o=this.options.fetch,c={method:"POST",headers:s,body:i,mode:"cors",credentials:"same-origin",cache:"no-cache"};o(this.options.emulationEndpoint,c)}}class q{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return null!==this.options.eventsource&&null!==this.options.fetch}initialize(e,t,n){let s;(s=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint)).searchParams.append("cf_connect",n);let i=new this.options.eventsource(s.toString(),{});this._transport=i,i.onopen=function(){t.onOpen()},i.onerror=function(e){i.close(),t.onError(e),t.onClose({code:4,reason:"connection closed"})},i.onmessage=function(e){t.onMessage(e.data)},this._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),null!==this._onClose&&this._onClose()}send(e,t,n){let s=JSON.stringify({session:t,node:n,data:e});(0,this.options.fetch)(this.options.emulationEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:s,mode:"cors",credentials:"same-origin",cache:"no-cache"})}}function B(e,t,n,s){return new(n||(n=Promise))(function(i,r){function o(e){try{a(s.next(e))}catch(e){r(e)}}function c(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(o,c)}a((s=s.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class F{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return void 0!==this.options.webtransport&&null!==this.options.webtransport}initialize(e,t){return B(this,void 0,void 0,function*(){let n,s;n=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint),"protobuf"===e&&n.searchParams.append("cf_protocol","protobuf"),this._protocol=e;let i=new EventTarget;this._transport=new this.options.webtransport(n.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch(e){this.close();return}try{s=yield this._transport.createBidirectionalStream()}catch(e){this.close();return}this._stream=s,this._writer=this._stream.writable.getWriter(),i.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),i.addEventListener("message",e=>{t.onMessage(e.data)}),this._startReading(i),t.onOpen()})}_startReading(e){return B(this,void 0,void 0,function*(){let t=this._stream.readable.getReader(),n="",s=0,i=new Uint8Array;try{for(;;){let{done:r,value:o}=yield t.read();if(o.length>0){if("json"===this._protocol)for(n+=this._utf8decoder.decode(o);s<n.length;)if("\n"===n[s]){let t=n.substring(0,s);e.dispatchEvent(new MessageEvent("message",{data:t})),n=n.substring(s+1),s=0}else++s;else{let t=new Uint8Array(i.length+o.length);for(t.set(i),t.set(o,i.length),i=t;;){let t=this.options.decoder.decodeReply(i);if(t.ok){let n=i.slice(0,t.pos);e.dispatchEvent(new MessageEvent("message",{data:n})),i=i.slice(t.pos);continue}break}}}if(r)break}}catch(t){e.dispatchEvent(new Event("close"))}})}close(){return B(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch(e){}})}send(e){return B(this,void 0,void 0,function*(){let t;t="json"===this._protocol?new TextEncoder().encode(e+"\n"):e;try{yield this._writer.write(t)}catch(e){this.close()}})}}class H{name(){return"json"}encodeCommands(e){return e.map(e=>JSON.stringify(e)).join("\n")}decodeReplies(e){return e.trim().split("\n").map(e=>JSON.parse(e))}}let K={token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null};class X extends Error{constructor(e){super(e),this.name=this.constructor.name}}class G extends U{constructor(e,t){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=m.Disconnected,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new H,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=Object.assign(Object.assign({},K),t),this._configure(),this._debugEnabled?(this.on("state",e=>{this._debug("client state",e.oldState,"->",e.newState)}),this.on("error",e=>{this._debug("client error",e)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(null!==this.getSubscription(e))throw Error("Subscription to the channel "+e+" already exists");let n=new M(this,e,t);return this._subs[e]=n,n}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&(e.state!==g.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){return this.state===m.Disconnected?Promise.reject({code:_.clientDisconnected,message:"client disconnected"}):this.state===m.Connected?Promise.resolve():new Promise((t,n)=>{let s={resolve:t,reject:n};e&&(s.timeout=setTimeout(function(){n({code:_.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=s})}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(p.disconnectCalled,"disconnect called",!1)}setToken(e){this._token=e}send(e){let t={send:{data:e}},n=this;return this._methodCall().then(function(){return n._transportSendCommands([t])?Promise.resolve():Promise.reject(n._createErrorObject(_.transportWriteError,"transport write error"))})}rpc(e,t){let n={rpc:{method:e,data:t}},s=this;return this._methodCall().then(function(){return s._callPromise(n,function(e){return{data:e.rpc.data}})})}publish(e,t){let n={publish:{channel:e,data:t}},s=this;return this._methodCall().then(function(){return s._callPromise(n,function(){return{}})})}history(e,t){let n={history:this._getHistoryRequest(e,t)},s=this;return this._methodCall().then(function(){return s._callPromise(n,function(t){let n=t.history,i=[];if(n.publications)for(let t=0;t<n.publications.length;t++)i.push(s._getPublicationContext(e,n.publications[t]));return{publications:i,epoch:n.epoch||"",offset:n.offset||0}})})}presence(e){let t={presence:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(e){let t=e.presence.presence;for(let e in t)if(t.hasOwnProperty(e)){let n=t[e].conn_info,s=t[e].chan_info;n&&(t[e].connInfo=n),s&&(t[e].chanInfo=s)}return{clients:t}})})}presenceStats(e){let t={presence_stats:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(e){let t=e.presence_stats;return{numUsers:t.num_users,numClients:t.num_clients}})})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){this._debugEnabled&&function(e,t){if(globalThis.console){let n=globalThis.console[e];I(n)&&n.apply(globalThis.console,t)}}("debug",e)}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw Error("Promise polyfill required");if(!this._endpoint)throw Error("endpoint configuration required");if(null!==this._config.token&&(this._token=this._config.token),null!==this._config.data&&(this._data=this._config.data),this._codec=new H,this._formatOverride(),(!0===this._config.debug||"undefined"!=typeof localStorage&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),"string"==typeof this._endpoint);else if("object"==typeof this._endpoint&&this._endpoint instanceof Array){for(let e in this._transports=this._endpoint,this._emulation=!0,this._transports)if(this._transports.hasOwnProperty(e)){let t=this._transports[e];if(!t.endpoint||!t.transport)throw Error("malformed transport configuration");let n=t.transport;if(0>["websocket","http_stream","sse","sockjs","webtransport"].indexOf(n))throw Error("unsupported transport name: "+n)}}else throw Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return this.state===m.Disconnected}_isConnecting(){return this.state===m.Connecting}_isConnected(){return this.state===m.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;null!==this._config.networkEventTarget?e=this._config.networkEventTarget:void 0!==globalThis.addEventListener&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),(this.state===m.Connected||this.state===m.Connecting)&&(this._disconnect(d.transportClosed,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===m.Connecting&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){let e=z(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(let e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){let t=this._callbacks[e];clearTimeout(t.timeout);let n=t.errback;if(!n)continue;n({error:this._createErrorObject(_.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){for(let e in this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout(),this._subs){if(!this._subs.hasOwnProperty(e))continue;let t=this._subs[e];t.state===g.Subscribed&&t._setSubscribing(b.transportClosed,"transport closed")}for(let e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(let t of e){let e=t.id;if(!(e in this._callbacks))continue;let n=this._callbacks[e];clearTimeout(this._callbacks[e].timeout),delete this._callbacks[e],(0,n.errback)({error:this._createErrorObject(_.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e,t;null!==this._config.websocket?e=this._config.websocket:"function"!=typeof globalThis.WebSocket&&"object"!=typeof globalThis.WebSocket||(e=globalThis.WebSocket);let n=null;null!==this._config.sockjs?n=this._config.sockjs:void 0!==globalThis.SockJS&&(n=globalThis.SockJS);let s=null;null!==this._config.eventsource?s=this._config.eventsource:void 0!==globalThis.EventSource&&(s=globalThis.EventSource);let i=null;null!==this._config.fetch?i=this._config.fetch:void 0!==globalThis.fetch&&(i=globalThis.fetch);let r=null;if(null!==this._config.readableStream?r=this._config.readableStream:void 0!==globalThis.ReadableStream&&(r=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let t=0;for(;;){if(t>=this._transports.length)throw Error("no supported transport found");let o=this._transports[this._currentTransportIndex],c=o.transport,a=o.endpoint;if("websocket"===c){if(this._debug("trying websocket transport"),this._transport=new N(a,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,t++;continue}}else if("webtransport"===c){if(this._debug("trying webtransport transport"),this._transport=new F(a,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,t++;continue}}else if("http_stream"===c){if(this._debug("trying http_stream transport"),this._transport=new J(a,{fetch:i,readableStream:r,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,t++;continue}}else if("sse"===c){if(this._debug("trying sse transport"),this._transport=new q(a,{eventsource:s,fetch:i,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,t++;continue}}else if("sockjs"===c){if(this._debug("trying sockjs"),this._transport=new W(a,{sockjs:n,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,t++;continue}}else throw Error("unknown transport "+c);break}}else{if(0===this._endpoint.lastIndexOf("http",0))throw Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new N(this._endpoint,{websocket:e}),!this._transport.supported())throw Error("WebSocket not available")}let o=this,c=this._transport,a=this._nextTransportId();o._debug("id of transport",a);let h=!1,l=!0;"sse"===this._transport.name()&&(l=!1);let u=[];if(this._transport.emulation()){let e=o._sendConnect(!0);if(u.push(e),l){let e=o._sendSubscribeCommands(!0,!0);for(let t in e)e.hasOwnProperty(t)&&u.push(e[t])}}this._setNetworkEvents();let b=this._codec.encodeCommands(u);this._transportClosed=!1,t=setTimeout(function(){c.close()},this._config.timeout),this._transport.initialize(this._codec.name(),{onOpen:function(){if(t&&(clearTimeout(t),t=null),o._transportId!=a){o._debug("open callback from non-actual transport"),c.close();return}h=!0,o._debug(c.subName(),"transport open"),o._transportWasOpen=!0,c.emulation()||(o.startBatching(),o._sendConnect(!1),l&&o._sendSubscribeCommands(!0,!1),o.stopBatching())},onError:function(e){if(o._transportId!=a){o._debug("error callback from non-actual transport");return}o._debug("transport level error",e)},onClose:function(e){if(t&&(clearTimeout(t),t=null),o._transportId!=a){o._debug("close callback from non-actual transport");return}o._debug(c.subName(),"transport closed"),o._transportClosed=!0;let n="connection closed",s=!0,i=0;if(e&&"code"in e&&e.code&&(i=e.code),e&&e.reason)try{let t=JSON.parse(e.reason);n=t.reason,s=t.reconnect}catch(t){n=e.reason,(i>=3500&&i<4e3||i>=4500&&i<5e3)&&(s=!1)}i<3e3?(1009===i?(i=p.messageSizeLimit,n="message size limit exceeded",s=!1):(i=d.transportClosed,n="transport closed"),o._emulation&&!o._transportWasOpen&&(o._currentTransportIndex++,o._currentTransportIndex>=o._transports.length&&(o._triedAllTransports=!0,o._currentTransportIndex=0))):o._transportWasOpen=!0,o._isConnecting()&&!h&&o.emit("error",{type:"transport",error:{code:_.transportClosed,message:"transport closed"},transport:c.name()}),o._reconnecting=!1,o._disconnect(i,n,s)},onMessage:function(e){o._dataReceived(e)}},b)}_sendConnect(e){let t=this._constructConnectCommand(),n=this;return this._call(t,e).then(e=>{let t=e.reply.connect;n._connectResponse(t),e.next&&e.next()},e=>{n._connectError(e.error),e.next&&e.next()}),t}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting()){this._debug("stop reconnecting: client not in connecting state");return}if(this._reconnecting){this._debug("reconnect already in progress, return from reconnect routine");return}if(!1===this._transportClosed){this._debug("waiting for transport close");return}this._reconnecting=!0;let e=this,t=""===this._token;if(!(this._refreshRequired||t&&null!==this._config.getToken)){this._config.getData?this._config.getData().then(function(t){e._isConnecting()&&(e._data=t,e._initializeTransport())}):this._initializeTransport();return}this._getToken().then(function(t){if(e._isConnecting()){if(null==t||void 0==t){e._failUnauthorized();return}e._token=t,e._debug("connection token refreshed"),e._config.getData?e._config.getData().then(function(t){e._isConnecting()&&(e._data=t,e._initializeTransport())}):e._initializeTransport()}}).catch(function(t){if(!e._isConnecting())return;if(t instanceof X){e._failUnauthorized();return}e.emit("error",{type:"connectToken",error:{code:_.clientConnectToken,message:void 0!==t?t.toString():""}});let n=e._getReconnectDelay();e._debug("error on connection token refresh, reconnect after "+n+" milliseconds",t),e._reconnecting=!1,e._reconnectTimeout=setTimeout(()=>{e._startReconnecting()},n)})}_connectError(e){this.state===m.Connecting&&(109===e.code&&(this._refreshRequired=!0),e.code<100||!0===e.temporary||109===e.code?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._reconnecting=!1,this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;!this._emulation||this._transportWasOpen||this._triedAllTransports||(e=!0);let t=this._getReconnectDelay();e&&(t=0),this._debug("reconnect after "+t+" milliseconds"),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_constructConnectCommand(){let e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version);let t={},n=!1;for(let e in this._serverSubs)if(this._serverSubs.hasOwnProperty(e)&&this._serverSubs[e].recoverable){n=!0;let s={recover:!0};this._serverSubs[e].offset&&(s.offset=this._serverSubs[e].offset),this._serverSubs[e].epoch&&(s.epoch=this._serverSubs[e].epoch),t[e]=s}return n&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){let n={channel:e};return void 0!==t&&(t.since&&(n.since={offset:t.since.offset},t.since.epoch&&(n.since.epoch=t.since.epoch)),void 0!==t.limit&&(n.limit=t.limit),!0===t.reverse&&(n.reverse=!0)),n}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{let n=setTimeout(function(){t({code:_.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_callPromise(e,t){return new Promise((n,s)=>{this._call(e,!1).then(e=>{n(t(e.reply)),e.next&&e.next()},e=>{s(e.error),e.next&&e.next()})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();let t=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let e;this._dispatchPromise=new Promise(t=>{e=t}),this._dispatchSynchronized(t,e)})}_dispatchSynchronized(e,t){let n=Promise.resolve();for(let t in e)e.hasOwnProperty(t)&&(n=n.then(()=>this._dispatchReply(e[t])));n.then(()=>{t()})}_dispatchReply(e){let t;let n=new Promise(e=>{t=e});if(null==e)return this._debug("dispatch: got undefined or null reply"),t(),n;let s=e.id;return s&&s>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),n}_call(e,t){return new Promise((n,s)=>{e.id=this._nextCommandId(),this._registerCall(e.id,n,s),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(m.Connecting)&&this.emit("connecting",{code:d.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,n){if(this._isDisconnected())return;let s=this.state,i={code:e,reason:t},r=!1;if(n?r=this._setState(m.Connecting):(r=this._setState(m.Disconnected),this._rejectPromises({code:_.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),s===m.Connecting&&this._clearReconnectTimeout(),s===m.Connected&&this._clearConnectedState(),r&&(this._isConnecting()?this.emit("connecting",i):this.emit("disconnected",i)),this._transport){this._debug("closing existing transport");let e=this._transport;this._transport=null,e.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(p.unauthorized,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),!this._config.getToken)throw this.emit("error",{type:"configuration",error:{code:_.badConfiguration,message:"token expired but no getToken function set in the configuration"}}),new X("");return this._config.getToken({})}_refresh(){let e=this._client,t=this;this._getToken().then(function(n){if(e!==t._client)return;if(!n){t._failUnauthorized();return}if(t._token=n,t._debug("connection token refreshed"),!t._isConnected())return;let s={refresh:{token:t._token}};t._call(s,!1).then(e=>{let n=e.reply.refresh;t._refreshResponse(n),e.next&&e.next()},e=>{t._refreshError(e.error),e.next&&e.next()})}).catch(function(e){if(t._isConnected()){if(e instanceof X){t._failUnauthorized();return}t.emit("error",{type:"refreshToken",error:{code:_.clientRefreshToken,message:void 0!==e?e.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return z(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),A(e.ttl)))}_removeSubscription(e){null!==e&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._isConnected())return;let t={channel:e.channel},n=this;this._call({unsubscribe:t},!1).then(e=>{e.next&&e.next()},e=>{e.next&&e.next(),n._disconnect(d.unsubscribeError,"unsubscribe error",!0)})}_getSub(e){return this._subs[e]||null}_isServerSub(e){return void 0!==this._serverSubs[e]}_sendSubscribeCommands(e,t){let n=[];for(let s in this._subs){if(!this._subs.hasOwnProperty(s))continue;let i=this._subs[s];if(!0!==i._inflight&&i.state===g.Subscribing){let s=i._subscribe(e,t);s&&n.push(s)}}return n}_connectResponse(e){if(this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(m.Connected),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),A(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(!1,!1),this.stopBatching();let t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=1e3*e.ping,this._sendPong=!0===e.pong,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];this._serverSubs[t]={offset:n.offset,epoch:n.epoch,recoverable:n.recoverable||!1};let s=this._getSubscribeContext(t,n);this.emit("subscribed",s)}for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];if(n.recovered){let e=n.publications;if(e&&e.length>0)for(let n in e)e.hasOwnProperty(n)&&this._handlePublication(t,e[n])}}for(let t in this._serverSubs)this._serverSubs.hasOwnProperty(t)&&(e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t]))}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){null!==this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){null!==this._serverPingTimeout&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){0!==this._config.maxServerPingDelay&&this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(d.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,t){let n={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1};t.recovered&&(n.recovered=!0),t.positioned&&(n.positioned=!0),t.recoverable&&(n.recoverable=!0),t.was_recovering&&(n.wasRecovering=!0);let s="";"epoch"in t&&(s=t.epoch);let i=0;return"offset"in t&&(i=t.offset),(n.positioned||n.recoverable)&&(n.streamPosition={offset:i,epoch:s}),t.data&&(n.data=t.data),n}_handleReply(e,t){let n=e.id;if(!(n in this._callbacks)){t();return}let s=this._callbacks[n];if(clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],"error"in e&&null!==e.error){let n=s.errback;if(!n){t();return}n({error:e.error,next:t})}else{let n=s.callback;if(!n)return;n({reply:e,next:t})}}_handleJoin(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let n={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",n)}return}n._handleJoin(t)}_handleLeave(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let n={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",n)}return}n._handleLeave(t)}_handleUnsubscribe(e,t){let n=this._getSub(e);if(!n){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}t.code<2500?n._setUnsubscribed(t.code,t.reason,!1):n._setSubscribing(t.code,t.reason)}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,n=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(n=!1),this._disconnect(t,e.reason,n)}_getPublicationContext(e,t){let n={channel:e,data:t.data};return t.offset&&(n.offset=t.offset),t.info&&(n.info=this._getJoinLeaveContext(t.info)),t.tags&&(n.tags=t.tags),n}_getJoinLeaveContext(e){let t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){let n=this._getSub(e);if(!n){if(this._isServerSub(e)){let n=this._getPublicationContext(e,t);this.emit("publication",n),void 0!==t.offset&&(this._serverSubs[e].offset=t.offset)}return}n._handlePublication(t)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){this._sendPong&&this._transportSendCommands([{}]),e()}_handlePush(e,t){let n=e.channel;e.pub?this._handlePublication(n,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(n,e.join):e.leave?this._handleLeave(n,e.leave):e.unsubscribe?this._handleUnsubscribe(n,e.unsubscribe):e.subscribe?this._handleSubscribe(n,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){let e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,n){let s={code:e,message:t};return n&&(s.temporary=!0),s}_registerCall(e,t,n){this._callbacks[e]={callback:t,errback:n,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],I(n)&&n({error:this._createErrorObject(_.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}}G.SubscriptionState=g,G.State=m,G.UnauthorizedError=X},22867:function(e,t,n){n.d(t,{y:function(){return i}});var s=n(2784);function i(){let e=new Set;function t(t){e.add(t)}function n(t){e.delete(t)}return{fire:t=>Array.from(e).map(e=>e(t)),useListen:function(e,i){(0,s.useEffect)(()=>(t(e),()=>n(e)),i)},listen:t,unlisten:n}}}}]);