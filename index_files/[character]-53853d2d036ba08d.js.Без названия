(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5564],{79151:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat/[character]",function(){return a(44233)}])},57881:function(e,t,a){"use strict";a.d(t,{w:function(){return x}});var r=a(52322),s=a(76193),n=a(23279),l=a(17063),i=a(2784),c=a(98614),o=a(8799),d=a(566),u=a(13964),h=a(38837);function m(e){var t,a;let{persona:s}=e,{participant__name:n,avatar_file_name:l}=s,i=(0,d.a)().user,{data:c}=(0,u.xS)(null!==(a=null==i?void 0:null===(t=i.user)||void 0===t?void 0:t.username)&&void 0!==a?a:"",!1);return(0,r.jsx)(h.B7,{...e,src:l||(null==c?void 0:c.avatar_file_name),name:n})}function x(e){let{persona:t,isDefault:a,handleItemClick:d,handleEditClick:u,selected:h,menuOptions:x,avatarSize:f,...v}=e,{t:g}=(0,c.$G)(),[p,j]=(0,i.useState)(!1),{participant__name:w,definition:b}=t;return(0,r.jsxs)("div",{className:(0,l.cn)("my-1 flex w-full h-fit group flex-row gap-3 p-2 items-center rounded-spacing-xs text-primary hover:cursor-pointer",u&&(a||h)?"bg-accent":"bg-transparent",u?"hover:bg-accent":"hover:bg-surface-elevation-3"),onClick:()=>d&&d(),...v,children:[(0,r.jsx)(m,{persona:t,size:null!=f?f:40,circle:!0}),(0,r.jsxs)("div",{className:"flex flex-1 flex-col w-full max-w-full justify-center",children:[(0,r.jsxs)("div",{className:"flex flex-1 gap-2 items-center",children:[(0,r.jsx)("p",{className:"line-clamp-1 text-ellipsis break-anywhere text-md sm:text-lg",children:w}),!!(a||h)&&(0,r.jsx)("p",{className:"text-blue text-md sm:text-lg",children:g(a?"Common.default":"Common.active")})]}),(0,r.jsx)("p",{className:"text-left text-sm sm:text-md mb-1 line-clamp-1 text-ellipsis break-anywhere text-muted-foreground",children:b})]}),!!u&&(0,r.jsx)(n.zx,{onPress:()=>{u&&u()},className:"hidden group-hover:block",variant:"primary",preventDefault:!0,children:g("Common.edit")}),!!x&&x.length>0&&(0,r.jsx)("div",{className:"z-50",children:(0,r.jsx)(s.C,{options:x,setIsOpen:j,isOpen:p,asChild:!0,children:(0,r.jsx)(n.zx,{variant:"ghost",isIconOnly:!0,preventDefault:!0,onPress:()=>j(!p),children:(0,r.jsx)(o.evw,{})})})})]})}},82047:function(e,t,a){"use strict";a.d(t,{$u:function(){return o},es:function(){return i},j$:function(){return c}});var r=a(35183),s=a(92526),n=a(24991),l=a(30195);let i=l.z.object({name:l.z.string().min(r.S1).max(r.vl).regex(s.vk,(0,n.t)("Form.invalid-characters")),definition:l.z.string().max(r.Ho),avatar_rel_path:l.z.string().optional(),enabled:l.z.boolean()}),c={external_id:"new",name:"",participant__name:"",definition:""},o=(e,t,a)=>{var r,s;let n=(null==a?void 0:null===(r=a.personaOverrides)||void 0===r?void 0:r[t])===e,l=(null==a?void 0:null===(s=a.personaOverrides)||void 0===s?void 0:s[t])===void 0,i=(null==a?void 0:a.default_persona_id)===e&&l;return n||i}},22769:function(e,t,a){"use strict";a.d(t,{R:function(){return m}});var r=a(52322),s=a(95112),n=a(36562),l=a(17063),i=a(1086),c=a(82876),o=a(2784),d=a(98614),u=a(90122),h=a(23279);function m(e){let{isCompact:t}=e,a="true"===(0,c.useSearchParams)().get("voice"),{t:m}=(0,d.$G)(),{isVoiceEnabled:x,enableVoice:f,disableVoice:v,onRequestVoice:g,hasVoice:p,voiceId:j}=(0,n.AW)(),{voice:w}=(0,i.Kl)(j,!1),[b,N]=(0,o.useState)(!1);if((0,o.useEffect)(()=>{a&&p&&f()},[p,a,f]),t)return x?(0,r.jsx)(h.zx,{"aria-label":m("Voice.toggle-voice"),onPress:v,variant:"outline",isIconOnly:!0,children:(0,r.jsx)(u.uA,{className:"size-4 text-voice-blue"})}):(0,r.jsx)(h.zx,{"aria-label":m("Voice.toggle-voice"),onPress:f,variant:"outline",isIconOnly:!0,children:p?(0,r.jsx)(u.As,{className:"size-4"}):(0,r.jsx)(u.TW,{className:"size-4"})});let y=!j&&p;return(0,r.jsxs)("div",{className:(0,l.cn)("flex gap-2 items-center rounded-spacing-xs",{"bg-surface-elevation-1":b}),onMouseEnter:()=>N(!0),onMouseLeave:()=>N(!1),children:[(0,r.jsx)("div",{className:"pl-3",children:x?(0,r.jsx)(s.l,{content:m("Chat.disable-voice-tooltip"),side:"left",children:(0,r.jsx)(h.zx,{"aria-label":m("Voice.toggle-voice"),onPress:v,variant:"ghost",isIconOnly:!0,className:"bg-surface-elevation-2 hover:bg-surface-elevation-3",style:{minWidth:30,width:30,height:30},children:(0,r.jsx)(u.uA,{className:"size-4 text-voice-blue"})})}):(0,r.jsx)(s.l,{content:m("Chat.enable-voice-tooltip"),side:"left",children:(0,r.jsx)(h.zx,{"aria-label":m("Voice.toggle-voice"),onPress:f,variant:"ghost",isIconOnly:!0,className:"bg-surface-elevation-2 hover:bg-surface-elevation-3",style:{minWidth:30,width:30,height:30},children:j?(0,r.jsx)(u.As,{className:"size-4"}):(0,r.jsx)(u.TW,{className:"size-4"})})})}),(0,r.jsxs)(h.zx,{variant:"ghost",className:"w-full flex justify-between rounded-spacing-xs pl-0 hover:bg-surface-elevation-1",onPress:g,children:[(0,r.jsx)("div",{className:"flex items-center w-fit",children:m("Chat.enable-voice")}),(0,r.jsxs)("div",{className:"flex gap-1 items-center text-muted-foreground",children:[!!y&&(0,r.jsx)("div",{children:m("Common.default")}),(0,r.jsx)("div",{children:null==w?void 0:w.name}),(0,r.jsx)("div",{children:(0,r.jsx)(u.XC,{className:"size-3"})})]})]})]})}},63485:function(e,t,a){"use strict";a.d(t,{E:function(){return i}});var r=a(52322),s=a(56964),n=a(2784),l=a(17063);let i=n.forwardRef((e,t)=>{let{className:a,value:n,...i}=e;return(0,r.jsx)(s.fC,{ref:t,className:(0,l.cn)("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...i,children:(0,r.jsx)(s.z$,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-(n||0),"%)")}})})});i.displayName=s.fC.displayName},10203:function(e,t,a){"use strict";a.d(t,{Y:function(){return h},Z:function(){return s}});var r,s,n=a(27617),l=a(5632),i=a(2784),c=a(30195);(r=s||(s={})).Characters="characters",r.Liked="liked",r.Voices="voices",r.Personas="personas";let o="characters",d=c.z.object({username:c.z.string(),tab:c.z.string()}).partial(),u=e=>e&&Object.values(s).includes(e)?e:o,h=e=>{let t=(0,l.useRouter)(),a=d.safeParse(t.query),{tab:r}=a.success?a.data:{tab:o},[s,c]=(0,i.useState)(u(r));return{selectedTab:s,handleTabChange:a=>{let r=u(a);c(r),t.replace(n.nN.profile(e,r),void 0,{shallow:!0})}}}},44233:function(e,t,a){"use strict";a.r(t),a.d(t,{__N_SSP:function(){return tV},default:function(){return tD},runtime:function(){return tU}});var r,s,n=a(52322),l=a(52914),i=a(2784),c=a(63554),o=a(71126),d=a(48683),u=a(61682),h=a(21565),m=a(566),x=a(7649),f=a(36562),v=a(87394),g=a(60614),p=a(99732),j=a(76709),w=a(25706),b=a(38837),N=a(74943),y=a(3988),C=a(22094),_=a(67324),k=a(44460),S=a(47969),z=a(71031);(r=s||(s={})).Disconnected="disconnected",r.Connecting="connecting",r.Connected="connected",r.Complete="complete",r.Failed="failed";let I=(e,t)=>{let{characterId:a}=(0,x.AU)(),r=(0,i.useRef)(0),s=(0,i.useRef)({character_id:a}),n=(0,i.useRef)(0),l=(0,i.useRef)("disconnected"),c=(0,z.Er)(e,t),o=(0,z.XV)(e,t);return(0,i.useEffect)(()=>{"disconnected"===l.current&&c&&(k.iN.voiceCallStateChange({referrer:"voice_call_analytics_hook",type:"connecting",...s.current}),n.current=Date.now(),l.current="connecting")},[c]),(0,i.useEffect)(()=>{"connecting"===l.current&&o&&(k.iN.voiceCallStateChange({referrer:"voice_call_analytics_hook",type:"connected",...s.current,connect_time_ms:Date.now()-n.current}),n.current=Date.now(),l.current="connected")},[o]),(0,i.useEffect)(()=>{t===S.Td.Backend&&r.current++},[t]),{logCallCompleted:(0,i.useCallback)(e=>{"connected"===l.current?(k.iN.voiceCallStateChange({referrer:"voice_call_analytics_hook",type:"complete",...s.current,user_turn_count:r.current,call_duration_ms:Date.now()-n.current,reason:e}),l.current="complete"):"connecting"===l.current&&(k.iN.voiceCallStateChange({referrer:"voice_call_analytics_hook",type:"failed",...s.current,user_turn_count:r.current,connect_time_ms:Date.now()-n.current,reason:e}),l.current="complete")},[])}};var E=a(32845),P=a(98614),M=a(15584);let O=e=>{var t;let[a,r]=(0,i.useState)(!1),s=(null===(t=(0,M.BF)(w.OO))||void 0===t?void 0:t.status)==="playing",n=(0,i.useRef)();return(0,i.useEffect)(()=>{e!==S.Td.Backend||e===n.current||s?r(!1):r(!0),n.current=e},[e,s]),{isAiThinking:a}},T=(e,t)=>{var a;let{t:r}=(0,P.$G)(),{character:s}=(0,x.AU)(),{token:n,user:l}=(0,m.a)(),c=null==l?void 0:null===(a=l.user)||void 0===a?void 0:a.username,[d,u]=(0,i.useState)(),{mconnect:h,mdisconnect:f,muteMicrophone:v,microphoneMuteStatus:g,rtcConnectionStatus:p,voiceCallTurnStatus:j,isUserSpeaking:b}=(0,_.D)(w.NT,e,t),{logCallCompleted:N}=I(p,j),y=(0,M.BF)(w.NT),[k,O]=(0,M.zb)(!1),{voiceId:T,voiceQuery:F,hasVoice:A,chatId:V,isVoiceLoading:U}=(0,E.E$)(),R=(0,i.useCallback)((e,t)=>{N(e),(null==t?void 0:t.toastProps)&&(0,C.K)(t.toastProps.text1)},[N]);(0,i.useEffect)(()=>{(0,z._v)(w.NT)},[]),(0,i.useEffect)(()=>()=>{N("unmount"),f()},[f,N]),(0,i.useEffect)(()=>{c&&n&&u({username:c,userAuthToken:n})},[c,n]);let D=y&&!!V&&!!(null==s?void 0:s.external_id)&&!U&&A&&!!d;return(0,i.useEffect)(()=>{D&&h({chatId:V,voiceId:T,voiceQuery:F,characterId:null==s?void 0:s.external_id,callArgs:d})},[h,D,null==s?void 0:s.external_id,V,T,F,d]),(0,i.useEffect)(()=>{if(O&&j===S.Td.Initializing){let e=setTimeout(()=>{(0,o.H)("Voice call initialization timeout",{type:o.NI.Voice}),R("no answer timeout",{toastProps:{text1:r("Voice.voice-call-connection-failed"),text2:r("Errors.please-try-again-later")}})},3e4);return()=>clearTimeout(e)}},[O,j,R,r]),(0,i.useEffect)(()=>{p===S.Fe.connecting||p===S.Fe.connected?k.value=!0:(p===S.Fe.failed||p===S.Fe.unconnected)&&k.value&&((0,o.H)("Voice call unexpectedly disconnected"),R("unexpected disconnect: ".concat(p)))},[p,k,R,r]),(0,i.useEffect)(()=>{!y&&k.value&&((0,o.H)("Voice call disabled unexpectedly",{type:o.NI.Voice}),R("externally disabled",{toastProps:{text1:r("Calls.voice-call-disconnected"),text2:r("Errors.please-try-again-later")}}))},[y,k,R,r]),{rtcConnectionStatus:p,voiceCallTurnStatus:j,hasVoice:A,muteMicrophone:v,hangUp:R,microphoneMuteStatus:g,isUserSpeaking:b,isVoiceLoading:U}};var F=a(83973),A=a(90834),V=a(27617),U=a(2236);let R={isConnected:!1,isConnecting:!1,isLoading:!0,voiceCallTurnStatus:S.Td.Initializing,hasVoice:!1,isUserMuted:!1,isAiThinking:!1,isUserSpeaking:!1,toggleMute:V.ws,hangUp:V.ws,audioTrackRef:void 0,isCharacterSpeaking:!1},D=i.createContext(R),$=e=>{let{children:t}=e,a=(0,i.useMemo)(()=>new MediaStream,[]),r=(0,i.useMemo)(()=>window.AudioContext?new AudioContext:null,[]),s=(0,i.useMemo)(()=>window.MediaStream?new MediaStream:null,[]),l=(0,i.useMemo)(()=>AudioContext?new AudioContext:null,[]),{character:c,characterId:o}=(0,x.AU)(),{refresh:d}=(0,U.m)();(0,i.useEffect)(()=>()=>d(o,!1,!0),[d,o]);let{rtcConnectionStatus:u,voiceCallTurnStatus:h,hasVoice:m,muteMicrophone:f,hangUp:v,microphoneMuteStatus:g,isUserSpeaking:p,isVoiceLoading:j}=T(a,s),{isAiThinking:w}=O(h),b=(0,i.useCallback)(()=>{f("user")},[f]),N=!c||j,y=(0,z.XV)(u,h),[C,_]=(0,i.useState)(!1);return(0,i.useEffect)(()=>{if(y&&a&&r)return(0,F.g)(a,r,()=>{_(!0)},()=>{_(!1)},A.vx.VoiceCallsMediaStream)},[r,y,a]),(0,i.useEffect)(()=>{if(y&&s&&l)return(0,F.g)(s,l,()=>{},()=>{},A.vx.VoiceCallsMicrophoneStream)},[l,y,s]),(0,i.useMemo)(()=>(0,n.jsx)(D.Provider,{value:{isLoading:N,isConnected:y,isConnecting:(0,z.Er)(u,h),voiceCallTurnStatus:h,hasVoice:m,isUserMuted:g===S.aB.UserMuted,isAiThinking:w,isUserSpeaking:p,isCharacterSpeaking:C,character:c,toggleMute:b,hangUp:v},children:t}),[C,N,y,u,h,m,g,w,p,c,b,v,t])},G=()=>(0,i.useContext)(D);var B=a(62780);let H={Connected:"connected.mp3",UserTurn:"turn_alt.mp3",CharacterTurn:"turn.mp3",Mute:"mute.mp3",Unmute:"unmute.mp3"},K=e=>{(0,B.Sk)("https://characterai.io/static/media/calls/".concat(e),"one-off",{})},X=()=>{let{voiceCallTurnStatus:e,isUserMuted:t}=G(),a=(0,i.useRef)(!1),r=(0,i.useRef)(!1);(0,i.useEffect)(()=>{e===S.Td.Client?a.current?K(H.UserTurn):K(H.Connected):e===S.Td.Backend&&(K(H.CharacterTurn),a.current=!0)},[e]),(0,i.useEffect)(()=>{t?K(H.Mute):r.current&&K(H.Unmute),r.current=t},[t])};var L=a(25854),Z=a(57352);let q={Character:25,User:100,Neutral:50},W="#0687F1",Y=0,Q=()=>{let{voiceCallTurnStatus:e,isConnecting:t}=G(),[a,r]=(0,i.useState)(q.Neutral),[s,l]=(0,i.useState)(0),[c,o]=(0,i.useState)(0),d=(0,L.G)(),{hasCustomBackground:u}=(0,g.OF)();(0,i.useEffect)(()=>{Y=Date.now();let e=(0,F.s)(A.vx.VoiceCallsMediaStream,e=>{l(Math.abs(e.reduce((e,t)=>e+t,0)/e.length)),function(e,t,a){var r;let s=document.getElementById("line-circle");if(!s)return;let n=function(e){let t=Math.max(...e.map(Math.abs));return e.map(e=>(e/t)**2)}(e),l=(r=J,n.map((e,a)=>{var s;return Number.isNaN(e)?0:(s=r[a])+(e-s)*t})),i=function(e,t){let a=new Float32Array(t),r=e.length/t;for(let n=0;n<t;n++){var s;let t=n*r,l=Math.floor(t),i=(l+1)%e.length,c=t-l;a[n]=(s=e[l])+(e[i]-s)*c}return a}(l,a),c=2*Math.PI/a;for(;s.firstChild;)s.removeChild(s.firstChild);for(let e=0;e<a;e++){let t=e*c,a=70+32*Math.abs(i[e]),r=128+a*Math.cos(t),n=75+a*Math.sin(t),l=document.createElementNS("http://www.w3.org/2000/svg","circle");l.setAttribute("cx",r.toString()),l.setAttribute("cy",n.toString()),l.setAttribute("r","5"),l.setAttribute("fill",W),s.appendChild(l)}J=l}(e,Math.min(.5,Math.abs(Y-Date.now())/128),36),Y=Date.now()});return()=>e()},[]),(0,i.useEffect)(()=>{let e=(0,F.s)(A.vx.VoiceCallsMicrophoneStream,e=>{o(4*Math.abs(e.reduce((e,t)=>e+t,0)/e.length))});return()=>e()},[]),(0,i.useEffect)(()=>{t?r(q.Neutral):e===S.Td.Backend?r(q.Character):e===S.Td.Client&&r(q.User)},[e,t]);let h=1e3+(e===S.Td.Backend?s:c)*1024,m=e===S.Td.Initializing?0:30;return(0,n.jsx)(Z.E.div,{className:"absolute flex justify-center items-start",transition:{ease:"easeInOut",type:"spring",duration:.25},animate:{background:"radial-gradient(circle ".concat(h,"px at 50% calc(").concat(a,"vh + 75px),  ").concat(W," 0%, ").concat("#1772b444"," ").concat(m,"%, ").concat(d?"#18181b":"#f8f8f8").concat(u?"00":""," 100%)")},style:{zIndex:-1,top:"0",height:"100%",width:"100%",transformOrigin:"center"},children:(0,n.jsx)("svg",{id:"line-circle",width:"256px",height:"256px",viewBox:"0 0 500 ".concat(a,"%"),className:"top-0 absolute overflow-visible origin-center pt-[".concat(q.Character,"vh]")})})},J=new Float32Array(18).fill(0);var ee=a(23279),et=a(90122),ea=a(17063);let er=()=>{let{t:e}=(0,P.$G)(),{hangUp:t,toggleMute:a,isUserMuted:r}=G(),s=e(r?"Calls.unmute":"Calls.mute");return(0,n.jsxs)("div",{className:"flex gap-8 text-sm text-center",children:[(0,n.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,n.jsxs)(ee.zx,{disableRipple:!0,size:"lg",variant:r?"primary":"ghost",onPressStart:()=>{a(),k.iN.elementClicked({referrer:"CallsControls",action:"mute_toggled",value:!r})},className:(0,ea.cn)({"bg-secondary":!r}),isIconOnly:!0,children:[!r&&(0,n.jsx)(et.nP,{height:"1.5em",color:"var--icon-primary)"}),!!r&&(0,n.jsx)(et.Ib,{height:"1.5em",color:"var(--icon-inverted)"})]}),(0,n.jsx)("div",{className:"text-sm font-light select-none",children:s})]}),(0,n.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,n.jsx)(ee.zx,{disableRipple:!0,size:"lg",onPressStart:()=>{k.iN.elementClicked({referrer:"CallsControls",action:"call_hangup_pressed"}),t("user hung up"),w.tI.value=!1},isIconOnly:!0,children:(0,n.jsx)(et.LX,{height:"1.5em",color:"var(--icon-inverted)"})}),(0,n.jsx)("div",{className:"text-sm font-light select-none",children:e("Calls.hang-up")})]})]})},es=()=>{let{character:e}=(0,x.AU)(),{hasVoice:t,isConnected:a,isCharacterSpeaking:r,isUserMuted:s,isAiThinking:l,voiceCallTurnStatus:c,isConnecting:o,isUserSpeaking:d}=G(),[u,h]=(0,i.useState)(0),[m,f]=(0,i.useState)(0);return(0,i.useEffect)(()=>{let e=(0,F.s)(A.vx.VoiceCallsMediaStream,e=>{h(Math.abs(e.reduce((e,t)=>e+t,0)/e.length))});return()=>e()},[]),(0,i.useEffect)(()=>{let e=(0,F.s)(A.vx.VoiceCallsMicrophoneStream,e=>{f(Math.abs(e.reduce((e,t)=>e+t,0)/e.length))});return()=>e()},[]),(0,n.jsxs)("div",{className:"absolute top-0 left-0 bg-black flex flex-col gap-1 font-mono text-white text-sm w-96 z-10",children:[(0,n.jsxs)("div",{children:["Character: ",null==e?void 0:e.name]}),(0,n.jsxs)("div",{children:["Is Connexting: ",o?"Yes":"No"]}),(0,n.jsxs)("div",{children:["Connected: ",a?"Yes":"No"]}),(0,n.jsxs)("div",{children:["User muted: ",s?"Yes":"No"]}),(0,n.jsxs)("div",{children:["AI thinking: ",l?"Yes":"No"]}),(0,n.jsxs)("div",{children:["Has voice: ",t?"Yes":"No"]}),(0,n.jsxs)("div",{children:["Character speaking: ",r?"Yes":"No"]}),(0,n.jsxs)("div",{children:["User speaking: ",d?"Yes":"No"]}),(0,n.jsxs)("div",{children:["Turn status: ",c]}),(0,n.jsxs)("div",{children:["Character Speech Amplitude: ",u.toFixed(6)]}),(0,n.jsxs)("div",{children:["Microphone Amplitude: ",m.toFixed(6)]})]})},en=()=>{let{t:e}=(0,P.$G)(),{stopCharacterSpeaking:t}=(0,E.c9)(),[a,r]=(0,i.useState)(!1),[s,l]=(0,i.useState)(),[c,o]=(0,i.useState)(!1),{isConnecting:d,hasVoice:u,voiceCallTurnStatus:h,isUserSpeaking:m,isUserMuted:x,isAiThinking:f}=G();return((0,i.useEffect)(()=>{m&&o(!0)},[m]),(0,i.useEffect)(()=>{let t=!1;u?d?l(e("Calls.status-calling")):h===S.Td.Client?x?l(e("Calls.status-muted")):c?l(e("Calls.status-listening")):l(e("Calls.status-start-speaking")):h===S.Td.Backend?f?l(e("Calls.status-ai-thinking")):(l(e("Calls.status-tap-to-interrupt")),t=!0):l(void 0):l(e("Calls.status-no-voice-selected")),r(t)},[h,d,u,c,x,f,e]),s)?(0,n.jsx)("div",{children:a?(0,n.jsx)(ee.zx,{onPress:()=>{t()},children:(0,n.jsx)("div",{children:s})}):(0,n.jsx)("div",{children:s})}):null};a(92908);let el=e=>{let{backgroundImageURL:t,small:a}=e,r=(0,i.useRef)(null),s=(0,i.useRef)(null);return(0,i.useEffect)(()=>{r.current&&s.current&&(r.current.style.setProperty("--cai-plus-custom-background","url(".concat(t,")")),s.current.style.setProperty("--cai-plus-custom-background","url(".concat(t,")")))},[t]),(0,n.jsxs)("div",{id:"chat-background",className:(0,ea.cn)("absolute left-0 w-full h-screen flex justify-center items-center overflow-hidden pointer-events-none",a?"h-full small":"h-screen"),children:[(0,n.jsx)("div",{ref:s,id:"background-blur-layer",className:"custom-background absolute w-full h-full bg-cover bg-center blur-3xl origin-center scale-[1.2]"}),(0,n.jsx)("div",{className:"background-layer tint-layer absolute w-full h-full"}),(0,n.jsx)("div",{ref:r,id:"foreground-image-layer",className:(0,ea.cn)("foreground-image absolute w-full h-full aspect-[9/16]",a?"max-w-[65%]":"max-w-screen-md")}),(0,n.jsx)("div",{className:"foreground-layer tint-layer absolute w-full h-full"})]})},ei=()=>{let{character:e}=(0,x.AU)(),{isStaff:t}=(0,m.a)(),a=(0,i.useRef)(null),{backgroundImageURL:r,hasCustomBackground:s}=(0,g.OF)();return(X(),e)?(0,n.jsx)(N.a2,{children:(0,n.jsxs)("div",{className:"absolute h-full w-full flex flex-col justify-between items-center p-32 pt-[25vh] z-20 bg-background top-0 left-0",children:[(0,n.jsx)("audio",{ref:a}),!!s&&!!r&&(0,n.jsx)("div",{className:"absolute w-full -z-10 top-0",children:(0,n.jsx)(el,{backgroundImageURL:r})}),(0,n.jsx)("div",{className:"absolute top-[10vh] left-0 flex w-full justify-center items-center",children:(0,n.jsx)(y.t,{})}),(0,n.jsx)(b.B7,{name:null==e?void 0:e.name,src:null==e?void 0:e.avatar_file_name,size:150}),(0,n.jsx)(en,{}),!!t&&(0,n.jsx)(es,{}),(0,n.jsx)(er,{}),(0,n.jsx)(Q,{})]})}):null};var ec=()=>((0,_.s)(),(0,n.jsx)($,{children:(0,n.jsx)(ei,{})})),eo=a(8883),ed=a(949),eu=a(30388),eh=a(77828),em=a(47843),ex=a(71338);function ef(e){let{character:t,referrer:a}=e,{t:r}=(0,P.$G)(),[s,l]=(0,i.useState)(!1),c={type:ex.C.CHARACTER,character:t};return(0,n.jsxs)(em.Vq,{open:s,onOpenChange:l,analyticsProps:{referrer:a,type:"ReportCharacterDialog"},children:[(0,n.jsx)(em.hg,{asChild:!0,children:(0,n.jsx)(ee.zx,{variant:"outline",isIconOnly:!0,"aria-label":r("Common.report"),children:(0,n.jsx)(et.cW,{className:"size-4 text-muted-foreground"})})}),(0,n.jsx)(eh.o,{isOpen:s,title:r("Moderation.report-character"),report:c,onComplete:()=>l(!1)})]})}var ev=a(78533),eg=a(57881),ep=a(82047),ej=a(10203),ew=a(35183),eb=a(19191),eN=a(88724),ey=a(82876);let eC=e=>{let{activePersonas:t,setOpen:a}=e,{t:r}=(0,P.$G)();return(0,n.jsxs)(ee.zx,{variant:"ghost",className:"w-full flex justify-between gap-2 rounded-spacing-xs",onPress:()=>{a(!0)},children:[(0,n.jsxs)("div",{className:"flex items-center w-fit gap-3",children:[(0,n.jsx)(et.IH,{className:"text-muted-foreground size-5"}),r("Common.persona")]}),(0,n.jsxs)("div",{className:"flex gap-1 items-center",children:[t.length>0&&(0,n.jsx)("p",{className:"line-clamp-1 text-ellipsis break-anywhere overflow-hidden whitespace-normal text-muted-foreground",children:t[0].participant__name}),(0,n.jsx)("div",{children:(0,n.jsx)(et.XC,{className:"text-muted-foreground size-3"})})]})]})};function e_(e){let{isLoading:t,open:a,setOpen:r,activePersonas:s,inactivePersonas:l,isError:i,refetch:c,handleNavigatePersona:o,handleSelect:d}=e,{t:u}=(0,P.$G)(),{user:h}=(0,m.a)();return t||!h?null:t||s.length+l.length!==0?(0,n.jsxs)(em.Vq,{open:a,onOpenChange:r,analyticsProps:{referrer:"Persona",type:"PersonaOverrideDialog"},children:[(0,n.jsx)(eC,{activePersonas:s,setOpen:r}),(0,n.jsxs)(em.cZ,{hideClose:!0,className:"flex-auto flex flex-col justify-between w-[440px] max-h-[560px] gap-2 pt-0",children:[(0,n.jsxs)("div",{className:"w-full flex justify-between sticky top-0 bg-popover z-10 pt-4",children:[(0,n.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,n.jsxs)(em.GG,{children:[(0,n.jsx)(eN.Z,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:u("Common.close")})]}),(0,n.jsx)("p",{children:u("Common.persona")})]}),(0,n.jsx)(ee.zx,{variant:"ghost",className:"border-muted-foreground border",onPress:()=>o("new"),children:u("Common.new")})]}),(0,n.jsx)("div",{className:"w-full h-full overflow-y-auto",children:i?(0,n.jsx)(ev.o,{refresh:c}):(0,n.jsxs)(n.Fragment,{children:[s.map(e=>(0,n.jsx)(eg.w,{persona:e,isDefault:!1,selected:!0,handleEditClick:()=>o(e.external_id),handleItemClick:()=>d(e.external_id)},e.external_id)),l.map(e=>(0,n.jsx)(eg.w,{persona:e,isDefault:!1,handleEditClick:()=>o(e.external_id),handleItemClick:()=>d(e.external_id),selected:!1},e.external_id))]})})]})]}):(0,n.jsxs)(ee.zx,{variant:"ghost",className:"flex justify-between w-fit",onPress:()=>o("new"),children:[(0,n.jsx)(et.IH,{className:"mr-2 size-5"}),u("Common.persona")]})}function ek(e){let{characterId:t}=e,{t:a}=(0,P.$G)(),{user:r}=(0,m.a)(),s=(0,ey.useRouter)(),[l,c]=(0,i.useState)(!1),{personas:d,isLoading:u,isError:h,refetch:x}=(0,ew.T4)(),{settings:f,isLoading:v,isError:g,refetch:p}=(0,eb.Fl)(),{mutate:j}=(0,eb.pC)(),w=h||g,b=(null!=d?d:[]).filter(e=>(0,ep.$u)(e.external_id,t,f)),N=(null!=d?d:[]).filter(e=>!(0,ep.$u)(e.external_id,t,f)),y=(0,i.useCallback)(async()=>{h&&await x(),g&&await p()},[h,x,g,p]),_=e=>{(0,C.K)(a("Error.something-went-wrong"),void 0,"destructive"),(0,o.H)("Failed to enable/disable persona-for-this-character",{error:e})};return(0,n.jsx)(e_,{isLoading:u||v,open:l,setOpen:c,activePersonas:b,inactivePersonas:N,isError:w,refetch:y,handleNavigatePersona:e=>{var t;(null==r?void 0:null===(t=r.user)||void 0===t?void 0:t.username)&&s.push(V.nN.profile(r.user.username,ej.Z.Personas,{id:e})),c(!1)},handleSelect:e=>{var r;let s={...null!==(r=null==f?void 0:f.personaOverrides)&&void 0!==r?r:{},[t]:(0,ep.$u)(e,t,f)?"":e};j({personaOverrides:s},{onSuccess:e=>{var r;if(!e||"NOT_OK"===e.status){_((null==e?void 0:e.error)||"Failed to update settings");return}k.iN.settingChanged({setting:"persona_updated",referrer:"PersonaOverrideDialog",character_id:t,value:null!==(r=s[t])&&void 0!==r?r:""}),(0,C.K)(a("Common.success")),c(!1)},onError:_})}})}var eS=a(76727),ez=a(22769),eI=a(11885),eE=a(18978);function eP(){let{t:e}=(0,P.$G)(),[t,a]=(0,i.useState)(!1);return(0,n.jsxs)(eI.yo,{onOpenChange:a,open:t,modal:!1,children:[(0,n.jsx)("div",{className:"flex justify-between items-center w-full",children:(0,n.jsxs)(ee.zx,{variant:"ghost",className:"w-full flex justify-between rounded-spacing-xs",onPress:()=>{w.qM.value=!0},children:[(0,n.jsxs)("div",{className:"flex items-center w-fit gap-3",children:[(0,n.jsx)(eE._TT,{className:"size-5 p-1"}),e("Customization.customize")]}),(0,n.jsx)("div",{className:"flex gap-1 items-center",children:(0,n.jsx)("div",{children:(0,n.jsx)(et.XC,{className:"text-muted-foreground size-3"})})})]})}),(0,n.jsx)(eI.ue,{className:"flex h-screen flex-col w-96 max-w-80 overflow-auto",children:(0,n.jsx)(eI.sw,{children:(0,n.jsxs)(eI.Tu,{className:"flex flex-row items-center gap-6",children:[(0,n.jsx)(et.XC,{className:"text-muted-foreground size-4"}),e("Customization.customize")]})})})]})}var eM=a(92262),eO=a(5632),eT=a(83605),eF=a(94766),eA=a(17380),eV=a(75658),eU=a(41332),eR=a(56462),eD=a(76193),e$=a(10661),eG=a(8799);let eB=i.forwardRef((e,t)=>{let{handleRenameOption:a}=e,{t:r}=(0,P.$G)();return(0,n.jsxs)("div",{onClick:e=>{e.stopPropagation(),a()},ref:t,className:"w-full flex justify-between items-center",children:[r("Common.rename"),(0,n.jsx)(et.dY,{width:"1rem",height:"1rem"})]})});eB.displayName="RenameOption";let eH=i.forwardRef((e,t)=>{let{handleArchiveOption:a,chatState:r}=e,{t:s}=(0,P.$G)();return(0,n.jsxs)("div",{onClick:e=>{e.stopPropagation(),a()},ref:t,className:"w-full flex justify-between items-center",children:[s(r===eV.sh.archived?"Common.unarchive":"Common.archive"),(0,n.jsx)(et.pN,{width:"1rem",height:"1rem"})]})});eH.displayName="ArchiveOption";let eK=e=>{let{open:t,setOpen:a,handleRenameOption:r,handleArchiveOption:s,chatState:l}=e,i=(0,e$.YQ)(),c=[];return l!==eV.sh.archived&&c.push({content:(0,n.jsx)(eB,{handleRenameOption:()=>{r(),a(!1)}}),asChild:!1,key:"rename"}),c.push({content:(0,n.jsx)(eH,{handleArchiveOption:()=>{s(),a(!1)},chatState:l}),asChild:!1,key:"archive-or-unarchive"}),(0,n.jsx)(eD.C,{options:c,setIsOpen:a,isOpen:t,asChild:!0,itemClassName:"p-2 px-3 hover:bg-[--transparency-4] text-primary rounded-spacing-xs",children:(0,n.jsx)(ee.zx,{variant:"ghost",className:(0,ea.cn)("min-w-unit-6 w-unit-6 h-unit-6 bg-transparent hover:bg-background opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-all",{"opacity-100":i}),onPress:()=>a(!0),size:"sm",isIconOnly:!0,preventDefault:!0,children:(0,n.jsx)(eG.evw,{})})})},eX=e=>{var t;let{lastDate:a,isRenaming:r,handleFinishRenaming:s,name:l}=e,{t:c}=(0,P.$G)(),[o,d]=(0,i.useState)(null!==(t=null!=l?l:a)&&void 0!==t?t:c("Common.new-chat"));return(0,n.jsx)("div",{className:"w-full",onBlur:e=>{requestAnimationFrame(()=>{var t;(null===(t=e.currentTarget)||void 0===t?void 0:t.contains(document.activeElement))||s(o)})},children:r?(0,n.jsx)(eR.I,{value:o,className:"p-1 px-[6px] rounded-spacing-xs",onClick:e=>e.stopPropagation(),onChange:e=>{e.stopPropagation(),d(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&s(o)},maxLength:eU.ew}):(0,n.jsx)("p",{className:"font-light text-ellipsis line-clamp-2 break-anywhere",children:null!=l?l:a})})};function eL(e){var t,a,r,s;let{history:l,characterId:c,isCurrentChat:d,onClickCallback:u,onArchiveCallback:h}=e,m=l.chat_id,[x,f]=(0,i.useState)(!1),v=(0,M.BF)(w.Kw),g=!!v&&l.chat_id===v,{t:p}=(0,P.$G)(),j=(0,eO.useRouter)(),b=l.last_interaction?(0,V.p6)(l.last_interaction):l.create_time?(0,V.p6)(l.create_time):null,{mutate:N}=(0,eU.os)(),{mutate:y}=(0,eU.I0)(),{mutate:_}=(0,eU.e7)();(0,i.useEffect)(()=>{w.Kw.value=void 0},[]);let S=null===(t=l.preview_turns)||void 0===t?void 0:t[0],z=(null==S?void 0:null===(a=S.candidates)||void 0===a?void 0:a.length)&&null!==(s=null===(r=S.candidates[0])||void 0===r?void 0:r.raw_content)&&void 0!==s?s:"";return z?(0,n.jsxs)("div",{onClick:()=>{l.state===eV.sh.archived||x||(l.isNeo?(k.iN.characterSelected({referrer:"ChatHistoryItem",characterId:c,chatId:l.chat_id}),j.push(V.nN.chat(c,"hist=".concat(l.chat_id)))):l.chat_id&&c?(w.Ek.value={historyId:l.chat_id,characterId:c},w.nj.value=!0,k.iN.characterSelected({referrer:"ChatHistoryItem",characterId:c,chatId:l.chat_id,action:"legacy_clicked"})):(0,C.K)("Legacy chat currently unavailable",void 0,"destructive"),null==u||u())},className:(0,ea.cn)("group hover:bg-surface-elevation-1 cursor-pointer p-2 rounded-spacing-xs",!!d&&"bg-surface-elevation-1 hover:bg-surface-elevation-2"),children:[!!d&&(0,n.jsx)("p",{className:"text-blue text-md",children:p("Common.current-chat")}),(0,n.jsxs)("div",{className:"items-start justify-start text-left gap-2 flex flex-col max-h-32 overflow-hidden text-ellipsis ",children:[(0,n.jsxs)("div",{className:"w-full flex gap-2 items-start justify-between",children:[(0,n.jsx)(eX,{isRenaming:g,lastDate:b,handleFinishRenaming:e=>{m&&e&&c&&N({chatId:m,name:e,characterId:c},{onSuccess:()=>k.iN.chatUpdated({changes:{name:e},referrer:"ChatHistoryItem",chatId:m}),onError:e=>{(0,o.H)("Failed to rename chat",{error:e}),(0,C.K)(p("Common.generic-error"),2500,"destructive")}}),w.Kw.value=void 0},name:l.name}),!l.isNeo&&(0,n.jsx)("p",{className:"text-center text-sm p-1 rounded-spacing-xs bg-secondary font-light",children:p("Common.legacy")}),(0,n.jsx)(eK,{handleRenameOption:()=>{w.Kw.value=l.chat_id},handleArchiveOption:()=>{if(!m)return;let e=l.state===eV.sh.archived?eV.sh.active:eV.sh.archived,t=()=>{k.iN.chatUpdated({changes:{name:e},referrer:"ChatHistoryItem",chatId:m}),(0,C.K)(e===eV.sh.archived?p("Chat.archived-chat"):p("Chat.unarchived-chat"),2500),e===eV.sh.archived&&h(m)},a=e=>{(0,o.H)("Failed to archive/unarchive chat",{error:e}),(0,C.K)(p("Common.generic-error"),2500,"destructive")};e===eV.sh.archived?y({chatId:m,characterId:c},{onSuccess:t,onError:a}):_({chatId:m,characterId:c},{onSuccess:t,onError:a})},chatState:l.state,open:x,setOpen:f})]}),(0,n.jsx)("p",{className:(0,ea.cn)("text-muted-foreground font-light",{"opacity-50":!l.isNeo}),children:z})]}),(0,n.jsx)(eS.Z,{className:"mt-2"})]}):null}let eZ=i.forwardRef((e,t)=>{let{showArchived:a,toggleArchived:r}=e,{t:s}=(0,P.$G)();return(0,n.jsxs)("div",{onClick:r,ref:t,className:"w-full flex justify-between items-center",children:[s(a?"Chat.chat-history":"Chat.archived-history"),a?(0,n.jsx)(et.F_,{width:"1rem",height:"1rem"}):(0,n.jsx)(et.pN,{width:"1rem",height:"1rem"})]})});eZ.displayName="ShowArchivedOption";let eq=e=>{let{showArchived:t,setShowArchived:a,open:r,setOpen:s}=e,l=[{content:(0,n.jsx)(eZ,{showArchived:t,toggleArchived:()=>{a(e=>!e),s(!1)}}),asChild:!1,key:"show-archived"}];return(0,n.jsx)(eD.C,{options:l,setIsOpen:s,isOpen:r,asChild:!0,itemClassName:"p-2 px-3 hover:bg-[--transparency-4] text-primary rounded-spacing-xs",children:(0,n.jsx)(ee.zx,{variant:"outline",className:"min-w-unit-5 w-unit-5 h-unit-5 bg-transparent hover:bg-background opacity-100",onPress:()=>s(!0),size:"sm",isIconOnly:!0,preventDefault:!0,children:(0,n.jsx)(eG.evw,{})})})};function eW(e){let{chatId:t}=e,[a,r]=(0,i.useState)(!1),[s,l]=(0,i.useState)(!1),c=(0,eO.useRouter)(),d=(0,ey.useSearchParams)(),{refresh:u}=(0,U.m)(),{t:h}=(0,P.$G)(),{characterId:m}=(0,x.AU)(),[f,v]=(0,i.useState)(!1),{histories:g,isLoading:p,refetch:j}=(0,eU.Ao)(f?m:null),w=eA.h.useUtils(),{mutate:b}=(0,eM.Kz)(),{deleteInstance:N}=(0,U.m)(),y=(0,i.useCallback)(e=>{var a;if(!t||e!==t||!g)return;let r=null===(a=g.filter(t=>t.state!==eV.sh.archived&&t.chat_id!==e))||void 0===a?void 0:a[0];r?c.replace(V.nN.chat(m,"hist=".concat(r.chat_id))):(N(m),b({externalId:m},{onSuccess:async()=>{await w.discovery.invalidate(),k.iN.characterUpdated({character_id:m,type:"hide_character",referrer:"ChatHistorySheet"}),c.replace("/")},onError:e=>(0,o.H)("Failed to hide character",{error:e})}))},[g,c,t,m,b,N,w.discovery]);(0,i.useEffect)(()=>{f&&(r(!1),j())},[f,j]);let C=!!m&&!!g,_=(0,i.useMemo)(()=>(null!=g?g:[]).filter(e=>a?e.state===eV.sh.archived:e.state!==eV.sh.archived),[g,a]);return(0,n.jsxs)(eI.yo,{onOpenChange:v,open:f,modal:!1,children:[(0,n.jsxs)(ee.zx,{variant:"ghost",className:"w-full flex justify-between rounded-spacing-xs",onPress:()=>{v(!0)},children:[(0,n.jsxs)("div",{className:"flex items-center w-fit gap-3",children:[(0,n.jsx)(et.F_,{className:"text-secondary-foreground size-5"}),h("Chat.chat-history")]}),(0,n.jsx)("div",{className:"flex gap-1 items-center",children:(0,n.jsx)("div",{children:(0,n.jsx)(et.XC,{className:"text-muted-foreground size-3"})})})]}),(0,n.jsxs)(eI.ue,{className:"flex h-screen flex-col w-96 max-w-80",children:[(0,n.jsxs)(eI.Tu,{className:"flex flex-row items-center gap-6",children:[(0,n.jsxs)(eI.sw,{className:"flex flex-row items-center gap-6",children:[(0,n.jsx)(et.XC,{className:"text-muted-foreground size-4"}),h(a?"Chat.archived-history":"Chat.chat-history")]}),(0,n.jsxs)("span",{className:"right-4 absolute flex flex-row gap-0 items-center",children:[(0,n.jsx)(ee.zx,{isIconOnly:!0,variant:"ghost",onPress:()=>{d&&c.push(V.nN.chat(m)),m&&u(m,!0,!0),k.iN.characterSelected({referrer:"ChatHistory",characterId:m,newHistory:!0,action:"save_and_start_new_chat"}),v(!1)},className:"opacity-50",children:(0,n.jsx)(et.jU,{height:"1.25em"})}),(0,n.jsx)(eq,{showArchived:a,setShowArchived:r,open:s,setOpen:l})]})]}),(0,n.jsxs)("div",{className:"overflow-y-scroll grow-1 flex flex-col gap-4 -mr-6 pr-2",children:[!!C&&_.map(e=>(0,n.jsx)(eL,{characterId:m,history:e,onClickCallback:()=>v(!1),onArchiveCallback:y,isCurrentChat:!!t&&e.chat_id===t},e.chat_id)),!!C&&0===_.length&&(0,n.jsx)("div",{className:"flex flex-col gap-2 items-center text-center",children:(0,n.jsx)("p",{children:h(a?"Chat.no-archived-chats-yet":"Chat.no-chats-yet")})}),p||!C&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eF.O,{className:"w-full h-32"}),(0,n.jsx)(eF.O,{className:"w-full h-32"}),(0,n.jsx)(eF.O,{className:"w-full h-32"}),(0,n.jsx)(eF.O,{className:"w-full h-32"}),(0,n.jsx)(eF.O,{className:"w-full h-32"})]})]})]})]})}var eY=a(63485),eQ=a(93808),eJ=a(47605);function e0(e){var t,a,r;let{turn:s,characterExternalId:l,handleRefetchPinnedTurns:c}=e,{t:o}=(0,P.$G)(),[d,u]=(0,i.useState)(!1),h=s.create_time?(0,V.p6)(s.create_time):null,m=null!==(r=null===(t=s.candidates.filter(e=>e.candidate_id===s.primary_candidate_id))||void 0===t?void 0:t[0])&&void 0!==r?r:null===(a=s.candidates)||void 0===a?void 0:a[0],{publish:x}=(0,U.m)(),f=async()=>{let e=s.turn_key;k.iN.messagePin({value:!1,referrer:"PinnedMemoryItem",...e}),x(l,{type:"set_turn_pin",turnKey:e,isPinned:!1}),await c(),u(!1)};return m?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(em.Vq,{open:d,onOpenChange:e=>u(e),analyticsProps:{referrer:"Settings",type:"SettingsDialog"},children:[(0,n.jsxs)(ee.zx,{variant:"ghost",onPress:()=>u(!0),className:"flex flex-col h-fit w-full justify-start hover:bg-surface-elevation-1 cursor-pointer p-2 rounded-spacing-xs",children:[(0,n.jsx)("div",{className:"w-full flex gap-2 items-center",children:(0,n.jsx)("p",{className:"font-light text-lg",children:h})}),(0,n.jsx)("div",{className:(0,ea.cn)("w-full text-left",s.author.is_human?"-mr-6 md:-mr-6":"-ml-6 md:-ml-6"),children:(0,n.jsx)(eJ.f,{turn:s,candidate:m})})]}),(0,n.jsxs)(em.cZ,{children:[(0,n.jsx)("p",{className:"mt-4",children:o("Chat.are-you-sure-you-want-to-unpin")}),(0,n.jsxs)("div",{className:"w-full flex flex-row justify-end gap-2",children:[(0,n.jsx)(ee.zx,{variant:"ghost",onPress:()=>u(!1),children:o("Common.cancel")}),(0,n.jsx)(ee.zx,{onPress:f,children:o("Common.yes")})]})]})]}),(0,n.jsx)(eS.Z,{className:"mt-4"})]}):null}let e1=e=>{var t,a;let{chatId:r}=e,{t:s}=(0,P.$G)(),{character:l}=(0,x.AU)(),{external_id:i,name:c,avatar_file_name:o}=null!=l?l:{},{user:d}=(0,m.a)(),u=null==d?void 0:null===(a=d.user)||void 0===a?void 0:null===(t=a.account)||void 0===t?void 0:t.avatar_file_name,{turns:h,meta:f,isLoading:v,fetchNextPage:g,refetch:p}=(0,eU.gL)(r),j=!!i&&!v&&!(0!==(null!=h?h:[]).length),w=!!(null==f?void 0:f.next_token),b=async()=>{await p()};return i?j?(0,n.jsxs)("div",{className:"flex flex-col gap-2 items-center text-center",children:[(0,n.jsx)("p",{children:s("Chat.no-pinned-memories-yet")}),(0,n.jsx)("p",{className:"text-sm",children:s("Chat.to-pin-a-memory",{name:null!=c?c:s("Chat.the-character")})})]}):(0,n.jsx)(eQ.Z,{dataLength:h.length,next:g,hasMore:w,loader:(0,n.jsx)("div",{className:"w-full flex items-center justify-center",children:(0,n.jsx)(eY.E,{})}),className:"flex w-full flex-col items-start gap-1",children:h.map(e=>{var t;return(0,n.jsx)(e0,{turn:{...e,author:{...e.author,avatar_url:null!==(t=e.author.avatar_url)&&void 0!==t?t:e.author.is_human?u:o}},characterExternalId:i,handleRefetchPinnedTurns:b},"pin-".concat(e.turn_key.turn_id))})}):void 0};function e2(e){let{chatId:t}=e,{t:a}=(0,P.$G)(),[r,s]=(0,i.useState)(!1);return(0,n.jsxs)(eI.yo,{onOpenChange:s,open:r,modal:!1,children:[(0,n.jsx)("div",{className:"flex justify-between items-center w-full",children:(0,n.jsxs)(ee.zx,{variant:"ghost",className:"w-full flex justify-between rounded-spacing-xs",onPress:()=>{s(!0)},children:[(0,n.jsxs)("div",{className:"flex items-center w-fit gap-3",children:[(0,n.jsx)(et.sh,{className:"text-secondary-foreground size-5"}),a("Chat.view-pinned-memories")]}),(0,n.jsx)("div",{className:"flex gap-1 items-center",children:(0,n.jsx)("div",{children:(0,n.jsx)(et.XC,{className:"text-muted-foreground size-3"})})})]})}),(0,n.jsxs)(eI.ue,{className:"flex h-screen flex-col w-96 max-w-80 overflow-auto",children:[(0,n.jsx)(eI.sw,{children:(0,n.jsxs)(eI.Tu,{className:"flex flex-row items-center gap-6",children:[(0,n.jsx)(et.XC,{className:"text-muted-foreground size-4"}),a("Chat.chat-pinned-memories")]})}),(0,n.jsx)("div",{className:"flex flex-col gap-4",children:(0,n.jsx)(e1,{chatId:t})})]})]})}function e4(e){let{characterId:t,chatId:a}=e;return(0,n.jsx)("div",{className:"bg-background z-0 w-80 h-full border-l border-l-divider flex-col p-4 gap-3 hidden 2xl:flex",children:(0,n.jsx)(e6,{characterId:t,chatId:a})})}function e6(e){var t;let{characterId:a,chatId:r,closeMenu:s}=e,{t:l}=(0,P.$G)(),{refresh:i}=(0,U.m)(),c=(0,eO.useRouter)(),o=(0,ey.useSearchParams)(),{user:d}=(0,m.a)(),{character:h}=(0,eM.XS)(null!=a?a:""),x=(0,p.M)();return h?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eT.uB,{characterId:a}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,n.jsx)(ed.o,{characterId:a}),(0,n.jsx)(eu.hv,{characterId:a})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(ef,{character:h}),(0,n.jsx)(eo.m,{thisIsMyCharacter:h.user__username===(null==d?void 0:null===(t=d.user)||void 0===t?void 0:t.username),character:h,alwaysShow:!0,contentClassName:"w-60"})]})]}),!!h.title&&(0,n.jsx)("p",{className:"text-muted-foreground text-sm",children:h.title}),(0,n.jsx)(eS.Z,{className:""}),(0,n.jsxs)("div",{className:"flex flex-col gap-3 h-fit",children:[(0,n.jsxs)(ee.zx,{color:"secondary",className:"flex justify-between w-fit gap-4 bg-brand-bg",onPress:()=>{o&&c.push(V.nN.chat(a)),a&&(i(a,!0,!0),s&&s()),k.iN.characterSelected({referrer:"ChatDetails",characterId:a,newHistory:!0,action:"save_and_start_new_chat"})},children:[(0,n.jsx)(et.jU,{className:"text-muted-foreground size-4"}),l("Chat.start-new-chat")]}),(0,n.jsx)(ez.R,{}),(0,n.jsx)(eW,{chatId:r}),!!x&&(0,n.jsx)(eP,{}),!!r&&(0,n.jsx)(e2,{chatId:r}),(0,n.jsx)(ek,{characterId:a}),(0,n.jsx)(u.sQ,{characterId:a})]})]}):(0,n.jsx)(eT.f7,{})}a(43710);var e3=e=>{let{showDismissibleDetailsPanel:t,children:a}=e;return(0,n.jsx)("div",{id:"chat-header-background",className:(0,ea.cn)("fixed left-0 top-0 w-screen h-20 z-[1] backdrop-blur-[20px] border-b-[0.5px] border-solid border-gray-200 dark:border-gray-800",{"2xl:hidden":!t}),children:(0,n.jsx)("div",{id:"chat-header",className:"relative w-full md:w-auto justify-between md:ml-14 p-6 pl-16 md:px-12 h-20 flex z-10 transition-all duration-300 ease-in-out ",children:a})})},e5=a(46870),e7=a(80147),e8=a(46367),e9=a(40040),te=a(39377),tt=a(35396),ta=a(20257);function tr(e){let{referrer:t}=e,{t:a}=(0,P.$G)(),{isPlusUser:r}=(0,m.a)(),s=(0,L.G)();return(0,n.jsx)("div",{className:"flex justify-center items-center ".concat(r?"":"cursor-pointer"," py-2"),style:{background:s?"linear-gradient(85deg, rgba(0, 97, 166, 0.15) 12.75%, rgba(27, 165, 251, 0.15) 95.41%)":"linear-gradient(85deg, rgba(160, 201, 255, 0.15) 12.75%, rgba(27, 165, 251, 0.15) 95.41%)"},onClick:()=>{r||(w.Um.value={referrer:t,trigger:"plus_feature_banner"})},children:(0,n.jsxs)("p",{className:"text-base text-muted-foreground",children:[a("Monetization.premium-feature-prefix")," ",(0,n.jsx)("span",{className:"text-base text-primary",children:a("Common.cai")}),(0,n.jsx)("span",{className:"text-[#1BA5FB]",children:"+"})]})})}var ts=a(18818);let tn=e=>{let{metadata:t,isHumanMessage:a}=e,{userChatColorOverride:r,characterChatColorOverride:s}=(0,g.Kx)(null==t?void 0:t.color_scheme_id);return(0,n.jsxs)("div",{className:(0,ea.cn)("w-[65%] flex",a?"flex-row-reverse":"flex-row"),children:[(0,n.jsx)("div",{className:"w-[5.6px] h-[5.6px] rounded-full",style:{background:"rgba(217, 217, 217, 1)"}}),(0,n.jsx)("div",{className:"w-[67.5px] h-[21.5px] mx-1 ".concat(a?"self-end bg-surface-elevation-3":"self-start bg-surface-elevation-2"),style:{background:a?r:s,borderRadius:"4.5px"}})]})};function tl(e){let{metadata:t}=e,{t:a}=(0,P.$G)();return(0,n.jsx)("div",{className:"w-full max-w-sm mx-auto",children:(0,n.jsxs)("div",{className:"overflow-hidden flex flex-col justify-center items-center h-48",children:[(0,n.jsx)("div",{className:"w-[180px] h-[120px] flex justify-center",children:(0,n.jsx)(ti,{metadata:t})}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground p-3",children:a("Customization.preview")})]})})}let ti=e=>{let{metadata:t}=e;return(0,n.jsxs)("div",{className:"w-full h-full rounded-[13.5px] relative border border-foreground-300 bg-surface overflow-hidden",children:[!!(null==t?void 0:t.background_image_url)&&(0,n.jsx)(el,{small:!0,backgroundImageURL:null==t?void 0:t.background_image_url}),(0,n.jsxs)("div",{className:"relative flex flex-col justify-center items-center w-full h-full gap-3",children:[(0,n.jsx)(tn,{metadata:t,isHumanMessage:!1}),(0,n.jsx)(tn,{metadata:t,isHumanMessage:!0})]})]})};var tc=a(5654),to=a(91262);let td=e=>{var t,a;return(null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.error)==="prompt does not meet our content guidelines"},tu=[[0],[5,6,7,8,-5,-6,-7,-8],[-2,-4,-3,-1,3,2,1,4],[0,1,-1,2,-2]],th=[[-3,-4,-5],[-2,-1,0],[0,-1,1],[5,3,4]],tm={lightTheme:{userBubbleColor:"rgba(217, 217, 223, 0.9)",characterBubbleColor:"rgba(228, 228, 231, 0.85)"},darkTheme:{userBubbleColor:"rgba(48, 49, 54, 0.9)",characterBubbleColor:"rgb(38, 39, 43, 0.85)"}};var tx=a(26498),tf=a(30538);let tv=()=>(0,tf.Db)(async e=>tx.m.generateImage(e));var tg=a(54504),tp=function(e){(0,i.useEffect)(e,[])},tj=function(e){var t=(0,i.useRef)(e);t.current=e,tp(function(){return function(){return t.current()}})},tw=function(e){var t=(0,i.useRef)(0),a=(0,i.useState)(e),r=a[0],s=a[1],n=(0,i.useCallback)(function(e){cancelAnimationFrame(t.current),t.current=requestAnimationFrame(function(){s(e)})},[]);return tj(function(){cancelAnimationFrame(t.current)}),[r,n]},tb=a(36883),tN=function(e,t){void 0===e&&(e=1/0),void 0===t&&(t=1/0);var a=tw({width:tb.jU?window.innerWidth:e,height:tb.jU?window.innerHeight:t}),r=a[0],s=a[1];return(0,i.useEffect)(function(){if(tb.jU){var e=function(){s({width:window.innerWidth,height:window.innerHeight})};return(0,tb.on)(window,"resize",e),function(){(0,tb.S1)(window,"resize",e)}}},[]),r},ty=a(6364);function tC(e){let{onBack:t,onBackgroundSelect:a,onCardSelect:r,onContextIdCreate:s}=e,{width:l}=tN(),c=(0,ts.Dv)(),{t:d}=(0,P.$G)(),[u,h]=(0,i.useState)(null),[m,x]=(0,i.useState)([]),[f,v]=(0,i.useState)(""),[g,p]=(0,i.useState)(!1),{mutate:j}=tv(),w=(0,i.useRef)(null),b=(0,i.useRef)(!1),N=(c?l:352)/4,y=16/9*N,_=(0,i.useMemo)(()=>m.map((e,t)=>{let a=tu[t%tu.length],r=a[Math.floor(Math.random()*a.length)],s=th[t%th.length],n=s[Math.floor(Math.random()*s.length)];return{top:"".concat(r,"px"),transform:"rotate(".concat(n,"deg)")}}),[m]),k=(0,i.useCallback)(()=>{if(!f.trim())return;p(!0),h(null);let e=(0,ty.Z)();r(void 0),j({prompt:f,imageSize:tg.jh.Portrait9x16,numImages:4,context_id:e},{onSuccess:t=>{x(t),p(!1),s(e)},onError:e=>{p(!1),td(e)?((0,o.H)("Failed to generate background image due to prompt",{error:e,extra:{prompt:f}}),(0,C.K)(d("Customization.image-prompt-error-title"),void 0,"destructive",d("Customization.image-prompt-error-description"))):((0,o.H)("Failed to generate background image",{error:e}),(0,C.A)())}})},[j,f,d,s,r]),S=e=>{h(e),r(e)};return(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full",children:[(0,n.jsxs)("div",{className:"flex justify-between w-full pr-3",children:[(0,n.jsx)(ee.zx,{variant:"ghost",onPress:t,children:(0,n.jsx)(et.xC,{className:"size-6 text-icon-primary"})}),!!u&&(0,n.jsx)(ee.zx,{variant:"primary",onPress:()=>{u&&(a(u),t())},children:d("Common.select")})]}),0===m.length&&!g&&(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center p-4 min-h-96",children:[(0,n.jsx)(et.tW,{className:"size-20 p-4 text-muted-foreground"}),(0,n.jsx)("p",{className:"text-center text-muted-foreground text-md",children:d("Customization.generate-description")})]}),!!g&&(0,n.jsx)(tc.Z,{className:"min-h-96"}),m.length>0&&!g&&(0,n.jsx)("div",{className:"relative flex items-end justify-center w-full min-h-96 px-2",children:m.map((e,t)=>{let{top:a,transform:r}=_[t];return(0,n.jsx)("div",{onClick:()=>S(e),className:(0,ea.cn)("rounded-xl shadow-lg cursor-pointer transition-transform duration-300 ease-in-out border-spacing-2 bg-cover bg-center bg-primary",u===e?"ring-4 ring-primary z-10":"ring-2 ring-foreground z-0 opacity-80","hover:scale-105","transform ".concat(0!==t?"-ml-1":"")),style:{backgroundImage:e?"url(".concat(e,")"):"none",width:"".concat(N,"px"),height:"".concat(y,"px"),top:a,transform:r}},t)})}),(0,n.jsx)("div",{className:"relative w-full mt-6 p-3",children:(0,n.jsx)("div",{className:"relative w-full flex items-center gap-2",children:(0,n.jsxs)("div",{className:"relative w-full",children:[(0,n.jsx)(to.g,{autoFocus:!c,ref:w,rows:1,className:"bg-background placeholder:text-placeholder border-1 border-border-outline h-12 py-3 px-4 rounded-3xl",inputMode:"text",placeholder:d("Customization.generate-placeholder"),onChange:e=>v(e.target.value),value:f,onCompositionStart:()=>{b.current=!0},onCompositionEnd:()=>{b.current=!1},onKeyDown:e=>{"Enter"!==e.key||b.current||e.shiftKey||(e.preventDefault(),k())}}),(0,n.jsx)("div",{onClick:()=>{var e;k(),null===(e=w.current)||void 0===e||e.focus()},className:"absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer",children:(0,n.jsx)(et.qz,{className:f?"text-primary":"text-placeholder",height:24})})]})})})]})}var t_=a(7329);function tk(e){let{selectedColorSchemeId:t,onColorSelect:a}=e,{t:r}=(0,P.$G)(),s=(0,L.G)(),l=(0,ts.Dv)(),[c,o]=(0,i.useState)(-1),d=(0,i.useMemo)(()=>{let e=Object.values(t_.I);return e.unshift(tm),e},[]);return(0,n.jsxs)("div",{className:"w-full flex flex-col items-center",children:[(0,n.jsxs)("div",{className:"w-full flex justify-between items-center pb-2 max-w-sm mx-auto",children:[(0,n.jsx)("h4",{className:"flex items-center",children:r("Customization.chat-color")}),(0,n.jsx)("span",{className:"text-sm flex items-center",children:r(t?"Customization.ColorSchemes.".concat(t):"Common.default")})]}),(0,n.jsx)("div",{className:"w-full max-w-sm px-4 py-2 rounded-sm border-1 border-foreground-200 flex justify-center",children:(0,n.jsx)("div",{className:"grid ".concat(l?"grid-cols-5":"grid-cols-6"," gap-5"),children:Object.values(d).map((e,t)=>(0,n.jsx)("div",{onClick:()=>{o(t),a(e.id)},className:"relative w-10 h-10 rounded-full cursor-pointer flex items-center justify-center ".concat(c===t?"ring-1 ring-offset-1 ring-current":""),children:(0,n.jsx)("div",{className:"w-9 h-9 rounded-full overflow-hidden",style:{backgroundImage:"linear-gradient(135deg, ".concat(s?e.darkTheme.characterBubbleColor:e.lightTheme.characterBubbleColor," 50%, ").concat(s?e.darkTheme.userBubbleColor:e.lightTheme.userBubbleColor," 50%)")}})},t))})})]})}let tS=e=>{let{chatId:t,character:a}=e,{t:r}=(0,P.$G)(),s=(0,M.BF)(w.qM),{isPlusUser:l}=(0,m.a)(),c=(0,ts.Dv)(),d=(0,ts.Fv)(),[u,h]=(0,i.useState)(!1),[x,f]=(0,i.useState)(void 0),[v,p]=(0,i.useState)(void 0),[j,b]=(0,i.useState)(void 0),{chat:N}=(0,g.RJ)(t),y=null==N?void 0:N.metadata,{mutate:_}=(0,eU.Mk)();(0,i.useEffect)(()=>{s&&k.iN.modalOpened({referrer:"Chat",type:"CustomizeChat"})},[s]),(0,i.useEffect)(()=>{t&&y&&p({...y,chat_id:t})},[t,y]);let S=(e,t)=>(null==e?void 0:e.background_image_url)!==(null==t?void 0:t.background_image_url),z=(e,t)=>(null==e?void 0:e.color_scheme_id)!==(null==t?void 0:t.color_scheme_id),I=(0,i.useMemo)(()=>z(v,y)||S(v,y),[v,y]),E=(0,i.useCallback)(e=>{if(!l){w.Um.value={referrer:"CustomizeChat",trigger:"set_color"};return}p(t=>t?(null==y?void 0:y.color_scheme_id)==="default"?{...t,color_scheme_id:void 0}:{...t,color_scheme_id:e===(null==y?void 0:y.color_scheme_id)?null==y?void 0:y.color_scheme_id:e}:t)},[l,y]),O=(0,i.useCallback)(e=>{p(t=>t?{...t,background_image_url:e}:t)},[]),T=(0,i.useCallback)(e=>{f(e)},[]),F=(0,i.useCallback)(()=>{p(e=>e?{...e,background_image_url:void 0}:e)},[]),A=(0,i.useCallback)(()=>{if(!l){w.Um.value={referrer:"CustomizeChat",trigger:"set_wallpaper"};return}f(void 0),h(!0)},[l]),V=(0,i.useCallback)(()=>{t&&I&&v&&_(v,{onSuccess:()=>{w.qM.value=!1,S(v,y)&&k.iN.settingChanged({setting:"chat_background",type:"changed",value:v.background_image_url,old_value:null==y?void 0:y.background_image_url,referrer:"CustomizeChatDialog",context_id:j}),z(v,y)&&k.iN.settingChanged({setting:"chat_color_scheme",type:"changed",value:v.color_scheme_id,old_value:null==y?void 0:y.color_scheme_id,referrer:"CustomizeChatDialog",context_id:j})},onError:e=>{(0,o.H)("Failed to update chat metadata",{error:e,extra:{chatId:t,newMetadata:v}}),(0,C.K)(r("Customization.save-failed"),void 0,"destructive")}})},[I,y,v,_,t,r,j]),U=(0,i.useCallback)(e=>{(e||!I||window.confirm(r("Common.unsaved-changes-warning")))&&(e||p(y),w.qM.value=!1)},[I,y,r]);return((0,i.useEffect)(()=>{!s&&I&&p(y)},[s,I,y]),v&&a)?(0,n.jsx)(em.Vq,{open:s,onOpenChange:U,children:(0,n.jsx)(em.cZ,{hideClose:!0,className:(0,ea.cn)("pt-[14px] max-w-lg overflow-y-auto flex flex-col gap-4 md:min-w-lg bg-surface-elevation-1 text-foreground border-spacing-3",c?"h-screen px-1.5 w-screen":"w-full","w-[400px] px-2",u&&x?"bg-cover bg-center bg-no-repeat":""),style:{backgroundImage:u&&x?"url(".concat(x,")"):"none"},children:u?(0,n.jsx)(tC,{onBack:()=>h(!1),onBackgroundSelect:O,onCardSelect:T,onContextIdCreate:b}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(em.fK,{className:"min-h-14 h-fit w-full flex flex-row justify-between items-center px-5 pt-1 -mb-4",children:[(0,n.jsxs)("div",{className:"flex flex-row gap-4 text-md items-center",children:[(0,n.jsxs)(em.GG,{children:[(0,n.jsx)(et.Tw,{height:"1.25em",color:"var(--icon-secondary)"}),(0,n.jsx)("span",{className:"sr-only",children:r("Common.close")})]}),(0,n.jsx)(em.$N,{children:r("Customization.customize")})]}),(0,n.jsx)("div",{className:"pr-4",children:!!I&&(0,n.jsx)(ee.zx,{variant:"primary",onPress:V,className:"mb-2",children:r("Common.save")})})]}),(0,n.jsx)(tr,{referrer:"CustomizeChat"}),(0,n.jsx)(tl,{metadata:v}),(0,n.jsx)("div",{className:"w-full flex flex-col items-center px-3",children:(0,n.jsxs)("div",{className:"w-full px-4 py-2 rounded-sm flex justify-between items-center border-1 border-foreground-200",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"m-0 font-md-semibold text-foreground",children:r("Customization.wallpaper")}),(0,n.jsx)("p",{className:"m-0 text-muted-foreground text-md",children:r("Customization.wallpaper-subtitle")})]}),(0,n.jsxs)("div",{className:"flex flex-col items-center gap-2 ml-2",children:[(0,n.jsx)(ee.zx,{className:"border-1 border-foreground-200 mb-2 min-w-[100px]",variant:v.background_image_url?"outline":"primary",onPress:A,children:v.background_image_url?r("Common.change"):r("Common.add")}),!!v.background_image_url&&(0,n.jsx)("span",{onClick:F,className:"cursor-pointer text-destructive text-sm-semibold",children:r("Form.remove")})]})]})}),(0,n.jsx)("div",{className:(0,ea.cn)("w-full px-3 rounded-sm shadow-sm",!d&&"py-2"),children:(0,n.jsx)(tk,{selectedColorSchemeId:v.color_scheme_id||"",onColorSelect:E})})]})})}):null};var tz=a(77257);a(47973);var tI=a(52370),tE=a(39783);function tP(e){let{characterId:t,chatId:a,hideOnLargeScreen:r}=e,[s,l]=(0,i.useState)(!1),{t:c}=(0,P.$G)();return(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(ez.R,{isCompact:!0}),(0,n.jsx)("div",{className:(0,ea.cn)({"2xl:hidden":r}),children:(0,n.jsxs)(eI.yo,{open:s,onOpenChange:l,modal:!1,children:[(0,n.jsx)(ee.zx,{"aria-label":c("Common.view-character-details"),variant:"outline",isIconOnly:!0,onPress:()=>{l(!0)},children:(0,n.jsx)(eG.evw,{})}),(0,n.jsx)(eI.ue,{className:"flex h-screen flex-col w-96",children:(0,n.jsx)(e6,{characterId:t,chatId:a,closeMenu:()=>l(!1)})})]})})]})}var tM=a(74973);function tO(e){var t;let{user:a,token:r}=(0,m.a)(),{characterId:s,characterPageUrl:l}=e,c=(0,M.BF)(w.AR);return(0,n.jsx)(U.R,{getAxiosInstance:j.H,neoEnabled:!0,originId:"web-next",userId:null==a?void 0:null===(t=a.user)||void 0===t?void 0:t.id,useCentrifuge:!1,errorLogger:o.H,children:(0,n.jsx)(x.Au,{children:(0,i.createElement)(tT,{...e,token:r,key:s,characterPageUrl:l})})},"".concat(s,"-debug:").concat(c))}function tT(e){var t;let{characterId:a,historyOverride:r,token:s,characterPageUrl:l}=e,{t:o}=(0,P.$G)(),{character:x,data:j,error:b}=(0,eM.XS)(null!=a?a:""),{isStaff:N}=(0,m.a)(),y=(0,M.BF)(w.tI),C=(null==j?void 0:j.data.status)==="NOT_OK",{processedTurns:_,chatId:k,primaryCandidateId:S,primaryCandidateMap:z,streamingStatus:I,introMessage:E,chatReady:O,showLoading:T}=(0,g.qw)(a,r);(0,g.bh)(),(0,d.Xu)("Chat",{character_id:a,chat_id:k},{disabled:!k}),(0,tI.JE)(_,a),(0,i.useEffect)(()=>{k&&(w.jN.value=k)},[k]),(0,g.io)();let F=(0,p.M)(),{chat:A}=(0,g.RJ)(k||void 0),V=null==A?void 0:null===(t=A.metadata)||void 0===t?void 0:t.background_image_url,U=(0,d.wz)(c.b.LargeScreenFocusedChats);if(C)return(0,n.jsxs)("div",{className:"w-full h-full flex flex-col justify-center items-center gap-4",children:[(0,n.jsx)(h.Z,{}),o("Chat.sorry-this-character-is-not-available-to-chat")]});let R=!!V&&!!F;return(0,n.jsx)(f.ie,{authToken:s,characterId:a,chatId:k,candidateId:S,onRequestVoice:()=>{w.UK.value=!0},children:(0,n.jsx)(v.X4,{children:(0,n.jsxs)(tz.B,{condition:N,chatTurns:null!=_?_:[],primaryCandidateMap:z,children:[!!x&&(0,n.jsx)(tt.e,{name:x.participant__name,title:x.title,avatar_url:x.avatar_file_name,characterId:a,character_page_url:l,author:x.user__username}),(0,n.jsx)(ta.B,{}),(0,n.jsxs)("div",{className:"flex h-screen","data-show_dismissible_details_panel":U,children:[(0,n.jsxs)("div",{className:"relative flex flex-col w-full items-center flex-1 h-screen",children:[!!R&&(0,n.jsx)(el,{backgroundImageURL:V}),(0,n.jsxs)(e3,{showDismissibleDetailsPanel:U,children:[!!a&&(0,n.jsx)(eT.Gn,{characterId:a,characterPageUrl:l}),(0,n.jsx)(tP,{characterId:a,chatId:null!=k?k:void 0,hideOnLargeScreen:!U})]}),(0,n.jsx)(u.mI,{}),(0,n.jsx)("div",{className:"relative flex flex-col items-center h-full w-full overflow-x-hidden",children:(0,n.jsx)("div",{id:"chat-body",className:"flex flex-col items-center absolute w-full h-full top-0 left-0",children:O?(0,n.jsxs)(n.Fragment,{children:[!T&&!!_&&(0,n.jsx)("div",{className:"relative flex w-full flex-col justify-start h-full overflow-y-scroll overflow-x-hidden align-middle",children:(0,n.jsx)(tM.j,{characterId:a,chatTurns:_,primaryCandidateMap:z,hasCustomBackground:R},a)}),!!T&&!!E&&(0,n.jsxs)("div",{className:"top-20 flex size-full flex-col justify-s max-w-3xl tart w-full align-middle relative",children:[(0,n.jsx)(e7.x,{turn:E,isLastTurn:!1,containerClassName:"mx-auto my-0",characterId:a}),(0,n.jsx)(e5.U,{})]}),(0,n.jsx)("div",{className:"flex w-full flex-col max-w-2xl",children:(0,n.jsx)(tE.JB,{streamingStatus:I,chatId:k})})]}):(0,n.jsx)(tF,{charError:b})})})]}),!U&&(0,n.jsx)(e4,{characterId:a,chatId:k||void 0}),(0,n.jsx)(e8.i,{}),(0,n.jsx)(e9.K,{})]}),!!y&&(0,n.jsx)(ec,{}),!!k&&!!x&&(0,n.jsx)(tS,{chatId:k,character:x})]})})})}let tF=e=>{let{charError:t}=e,{t:a}=(0,P.$G)();return(0,n.jsxs)("div",{className:"top-20 flex size-full flex-col justify-s max-w-3xl tart w-full align-middle relative",children:[!!t&&(0,n.jsxs)("div",{className:"mt-12 flex justify-center items-center flex-col gap-3",children:[(0,n.jsx)(h.Z,{}),a("Chat.something-went-wrong-loading-the-chat"),(0,n.jsx)("div",{className:"text-mono text-sm text-muted-foreground",children:t instanceof Error&&t.message})]}),!t&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(te.N,{}),(0,n.jsx)(e5.U,{})]}),(0,n.jsx)("div",{className:"flex w-full  flex-col max-w-2xl absolute bottom-12",children:(0,n.jsx)(tE.QT,{})})]})};var tA=a(94071),tV=!0;let tU="experimental-edge",tR=e=>{let{isSignedOut:t,characterId:a,historyOverride:r,characterPageUrl:s}=e;return t?(0,n.jsx)(tA.Y,{characterId:a,characterPageUrl:s}):(0,n.jsx)(tO,{characterId:a,historyOverride:r,characterPageUrl:s})};tR.getLayout=function(e){return(0,n.jsx)(l.d,{children:e})},tR.SignedOut=tR;var tD=tR},20257:function(e,t,a){"use strict";a.d(t,{B:function(){return V},K:function(){return U}});var r=a(52322),s=a(76492),n=a(14976),l=a(93814),i=a(14256),c=a(91282),o=a(90122),d=a(23279),u=a(7649),h=a(27232),m=a(47969),x=a(98614);function f(e){let{voice:t,onClickSelectButton:a,onClickDetailView:s,isSelected:n,systemSuggestedVoice:l}=e,{t:c}=(0,x.$G)(),u="private"===t.visibility;return(0,r.jsxs)("div",{className:"px-4 py-2 group gap-3 flex items-center hover:bg-surface-elevation-3 w-full max-w-lg",children:[(0,r.jsx)(i.K,{id:t.id,className:"w-14 h-14 shrink-0"}),(0,r.jsxs)("div",{onClick:s,className:"grow flex flex-col bg-transparent rounded-none justify-start items-start p-0 h-full text-md text-muted-foreground hover:cursor-pointer gap-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1 text-foreground",children:[(0,r.jsx)("p",{className:"line-clamp-1 text-left break-all",children:t.name}),!!u&&(0,r.jsx)(o.mB,{className:"size-4 min-w-4"})]}),(0,r.jsx)(v,{voice:t,systemSuggestedVoice:l})]}),!!n&&(0,r.jsx)(o.KM,{className:"block md:group-hover:hidden mr-3",color:"#0687F1",height:"1.25em",width:"1.25em"}),(0,r.jsx)(d.zx,{onPress:a,className:"hidden md:group-hover:block",variant:n?"outline":"primary",children:c(n?"Common.unselect":"Common.select")})]})}let v=e=>{let{voice:t,systemSuggestedVoice:a}=e,{t:s}=(0,x.$G)(),{characterId:n,character:l}=(0,u.AU)(),{voiceOverride:i}=(0,h.uO)(n),d=i&&i.voice_id!==(null==l?void 0:l.default_voice_id);switch(g(t.id,!!d,null==l?void 0:l.default_voice_id,a)){case m.sF.Creator:return(0,r.jsx)("div",{className:"bg-accent text-sm text-primary rounded-sm p-2 pb-1 pt-1",children:s("Voice.default")});case m.sF.System:return(0,r.jsxs)("div",{className:"bg-accent text-sm text-primary rounded-sm p-2 pb-1 pt-1 flex gap-1 items-center",children:[(0,r.jsx)(o.qz,{width:"0.75rem",height:"0.75rem"}),(0,r.jsx)("div",{children:s("Voice.system-suggested")})]});default:return(0,r.jsx)(c.g,{voice:t,clickable:!1})}},g=(e,t,a,r)=>t||!e?void 0:e===a?m.sF.Creator:e===r?m.sF.System:void 0;var p=a(17063);function j(e){let{children:t,className:a,...s}=e;return(0,r.jsx)("div",{className:(0,p.cn)("flex items-center justify-center",a),...s,children:t})}var w=a(47843),b=a(13074),N=a(566),y=a(36562),C=a(25706),_=a(35113),k=a(63554);let S=()=>{var e;let t=_.w.getAmplitudeVariantPayload(k.b.DemoteSystemVoices);return null!==(e=null==t?void 0:t.startIndex)&&void 0!==e?e:0};var z=a(27617),I=a(56462),E=a(2784);function P(e){let{onChange:t,searchQuery:a,isSearchLoading:n,iconSize:l,clearSearch:i}=e,{t:c}=(0,x.$G)(),u=(0,E.useRef)(null);return(0,r.jsxs)("div",{className:"z-40 flex w-full max-w-lg border-spacing-1 flex-row self-center items-center rounded-none bg-transparent p-0 placeholder:text-muted-foreground border-t-px border-b-px border-accent",children:[(0,r.jsx)(d.zx,{variant:"ghost",isIconOnly:!0,onPress:()=>{var e;null===(e=u.current)||void 0===e||e.focus()},className:"ml-3",children:n?(0,r.jsx)(s.$,{size:l}):(0,r.jsx)(o.W1,{height:"16px",className:"text-muted-foreground"})}),(0,r.jsx)(I.I,{className:"rounded-none border-none bg-transparent placeholder:text-placeholder pl-0",type:"text",ref:u,placeholder:c("Voice.search-label"),onChange:t,value:a,label:""}),!!a&&(0,r.jsx)(d.zx,{variant:"ghost",isIconOnly:!0,className:"mr-4",onPress:i,children:(0,r.jsx)(o.Tw,{height:"1em"})})]})}var M=a(1086),O=a(7163),T=a(88724),F=a(5632),A=a(15584);function V(){let{overrideVoice:e,voiceId:t}=(0,y.AW)();return(0,h.yW)(t),(0,r.jsx)(U,{selectVoice:(a,r)=>{e(t===a?void 0:a,"ChatVoiceSelection",r),C.UK.value=!1},selectedVoiceId:t})}function U(e){var t,a;let{selectVoice:s,selectedVoiceId:i,renderTrigger:c,implicitVoiceSearchString:o}=e,{t:m}=(0,x.$G)(),{searchQuery:f,searchResults:v,isSearchLoading:g,clearSearch:p,onChangeSearchText:j}=(0,n.T4)(void 0,!1,"ChatVoiceSelection"),{character:y}=(0,u.AU)(),_=(0,F.useRouter)(),k=(0,A.BF)(C.UK),{searchResults:I}=(0,M.Vo)(null!==(a=null!=o?o:null==y?void 0:y.name)&&void 0!==a?a:"",!0,!k),{voices:V}=(0,M.qc)(),{voices:U}=(0,M.f$)(),{stopVoicePreview:D}=(0,h.ZU)(null),{voice:$}=(0,M.Kl)(null==y?void 0:y.default_voice_id,!0),G=$?void 0:null==I?void 0:null===(t=I[0])||void 0===t?void 0:t.id,{voice:B}=(0,M.Kl)(i,!0),{user:H}=(0,N.a)(),[K,X]=(0,E.useState)(O.Xg.Discover),[L,Z]=(0,E.useState)(null),q=e=>{Z(e)};(0,E.useEffect)(()=>{Z(null)},[i]);let W=(0,E.useMemo)(()=>(0,O.dx)({tab:K,user:H,currentlySelectedVoice:B,defaultCharacterVoice:$,implicitSearchResults:I,searchQuery:f,searchResults:v,systemVoices:V,userVoices:U,systemVoiceStartIndex:S()}),[K,H,B,$,I,f,v,V,U]);(0,E.useEffect)(()=>{D()},[D,W]);let Y=(0,E.useMemo)(()=>W.find(e=>e.id===L),[L,W]);return Y?(0,r.jsx)(l.V,{isOpen:k,voice:Y,onClose:()=>q(null),isSelected:i===Y.id,selectVoice:e=>s(e,f),referrer:"ChatVoiceSelection",action:"override"}):(0,r.jsxs)(w.Vq,{open:k,onOpenChange:e=>{C.UK.value=e},analyticsProps:{referrer:"ChatVoice",type:"ChatVoiceSelection"},children:[null==c?void 0:c(),(0,r.jsxs)(w.cZ,{className:"p-0 cursor-default w-full max-w-lg h-screen md:h-screen-70 overflow-y-auto overflow-x-hidden flex flex-col",hideClose:!0,children:[(0,r.jsxs)(w.fK,{className:"h-fit w-full flex flex-row justify-between items-center px-5 pt-1 -mb-4",children:[(0,r.jsxs)("div",{className:"flex flex-row gap-4 text-md items-center",children:[(0,r.jsxs)(w.GG,{children:[(0,r.jsx)(T.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,r.jsx)("span",{className:"sr-only",children:m("Common.close")})]}),(0,r.jsx)(w.$N,{children:m("Voice.voices")})]}),(0,r.jsx)(d.zx,{variant:"outline",onPress:()=>{_.push(z.nN.voice())},children:m("CreateVoice.screen.create")})]}),(0,r.jsx)(b.mQ,{value:K.toString(),tabIndex:-1,onValueChange:e=>X(e===O.Xg.Discover.toString()?O.Xg.Discover:O.Xg.YourVoices),className:"flex flex-col m-0 p-0 items-start",children:(0,r.jsxs)(b.dr,{className:"px-4 pb-0 -mb-px",children:[(0,r.jsx)(b.SP,{value:O.Xg.Discover.toString(),children:m("Voice.discover")}),(0,r.jsx)(b.SP,{value:O.Xg.YourVoices.toString(),children:m("Voice.your-voices")})]})}),(0,r.jsxs)("div",{className:"overflow-y-auto -mt-4",children:[K===O.Xg.Discover&&(0,r.jsx)(P,{onChange:e=>j(e.target.value),searchQuery:f,isSearchLoading:g,iconSize:16,clearSearch:p}),(0,r.jsx)(R,{onSelect:e=>s(e,f),onSelectDetailView:q,selectedVoiceId:null==B?void 0:B.id,systemSuggestedVoice:G,voices:W})]})]})]})}function R(e){let{onSelect:t,onSelectDetailView:a,selectedVoiceId:n,voices:l,isLoading:i,systemSuggestedVoice:c}=e,{t:o}=(0,x.$G)();return i?(0,r.jsx)(j,{className:"h-20",children:(0,r.jsx)(s.$,{size:16})}):0===l.length?(0,r.jsx)(j,{className:"h-20",children:o("Voice.no-voices")}):(0,r.jsx)("div",{className:"gap-3 flex flex-col py-2 h-auto -mt-1",children:l.map(e=>(0,r.jsx)(f,{voice:e,onClickSelectButton:()=>t(e.id),onClickDetailView:()=>a(e.id),isSelected:n===e.id,systemSuggestedVoice:c},e.id))})}},47973:function(){},92908:function(){},43710:function(){},69172:function(e,t){"use strict";t.Z={'pre[class*="language-"]':{color:"#d4d4d4",fontSize:"13px",textShadow:"none",fontFamily:'Menlo, Monaco, Consolas, "Andale Mono", "Ubuntu Mono", "Courier New", monospace',direction:"ltr",textAlign:"left",whiteSpace:"pre",wordSpacing:"normal",wordBreak:"normal",lineHeight:"1.5",MozTabSize:"4",OTabSize:"4",tabSize:"4",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",hyphens:"none",padding:"1em",margin:".5em 0",overflow:"auto",background:"#1e1e1e"},'code[class*="language-"]':{color:"#d4d4d4",fontSize:"13px",textShadow:"none",fontFamily:'Menlo, Monaco, Consolas, "Andale Mono", "Ubuntu Mono", "Courier New", monospace',direction:"ltr",textAlign:"left",whiteSpace:"pre",wordSpacing:"normal",wordBreak:"normal",lineHeight:"1.5",MozTabSize:"4",OTabSize:"4",tabSize:"4",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",hyphens:"none"},'pre[class*="language-"]::selection':{textShadow:"none",background:"#264F78"},'code[class*="language-"]::selection':{textShadow:"none",background:"#264F78"},'pre[class*="language-"] *::selection':{textShadow:"none",background:"#264F78"},'code[class*="language-"] *::selection':{textShadow:"none",background:"#264F78"},':not(pre) > code[class*="language-"]':{padding:".1em .3em",borderRadius:".3em",color:"#db4c69",background:"#1e1e1e"},".namespace":{Opacity:".7"},"doctype.doctype-tag":{color:"#569CD6"},"doctype.name":{color:"#9cdcfe"},comment:{color:"#6a9955"},prolog:{color:"#6a9955"},punctuation:{color:"#d4d4d4"},".language-html .language-css .token.punctuation":{color:"#d4d4d4"},".language-html .language-javascript .token.punctuation":{color:"#d4d4d4"},property:{color:"#9cdcfe"},tag:{color:"#569cd6"},boolean:{color:"#569cd6"},number:{color:"#b5cea8"},constant:{color:"#9cdcfe"},symbol:{color:"#b5cea8"},inserted:{color:"#b5cea8"},unit:{color:"#b5cea8"},selector:{color:"#d7ba7d"},"attr-name":{color:"#9cdcfe"},string:{color:"#ce9178"},char:{color:"#ce9178"},builtin:{color:"#ce9178"},deleted:{color:"#ce9178"},".language-css .token.string.url":{textDecoration:"underline"},operator:{color:"#d4d4d4"},entity:{color:"#569cd6"},"operator.arrow":{color:"#569CD6"},atrule:{color:"#ce9178"},"atrule.rule":{color:"#c586c0"},"atrule.url":{color:"#9cdcfe"},"atrule.url.function":{color:"#dcdcaa"},"atrule.url.punctuation":{color:"#d4d4d4"},keyword:{color:"#569CD6"},"keyword.module":{color:"#c586c0"},"keyword.control-flow":{color:"#c586c0"},function:{color:"#dcdcaa"},"function.maybe-class-name":{color:"#dcdcaa"},regex:{color:"#d16969"},important:{color:"#569cd6"},italic:{fontStyle:"italic"},"class-name":{color:"#4ec9b0"},"maybe-class-name":{color:"#4ec9b0"},console:{color:"#9cdcfe"},parameter:{color:"#9cdcfe"},interpolation:{color:"#9cdcfe"},"punctuation.interpolation-punctuation":{color:"#569cd6"},variable:{color:"#9cdcfe"},"imports.maybe-class-name":{color:"#9cdcfe"},"exports.maybe-class-name":{color:"#9cdcfe"},escape:{color:"#d7ba7d"},"tag.punctuation":{color:"#808080"},cdata:{color:"#808080"},"attr-value":{color:"#ce9178"},"attr-value.punctuation":{color:"#ce9178"},"attr-value.punctuation.attr-equals":{color:"#d4d4d4"},namespace:{color:"#4ec9b0"},'pre[class*="language-javascript"]':{color:"#9cdcfe"},'code[class*="language-javascript"]':{color:"#9cdcfe"},'pre[class*="language-jsx"]':{color:"#9cdcfe"},'code[class*="language-jsx"]':{color:"#9cdcfe"},'pre[class*="language-typescript"]':{color:"#9cdcfe"},'code[class*="language-typescript"]':{color:"#9cdcfe"},'pre[class*="language-tsx"]':{color:"#9cdcfe"},'code[class*="language-tsx"]':{color:"#9cdcfe"},'pre[class*="language-css"]':{color:"#ce9178"},'code[class*="language-css"]':{color:"#ce9178"},'pre[class*="language-html"]':{color:"#d4d4d4"},'code[class*="language-html"]':{color:"#d4d4d4"},".language-regex .token.anchor":{color:"#dcdcaa"},".language-html .token.punctuation":{color:"#808080"},'pre[class*="language-"] > code[class*="language-"]':{position:"relative",zIndex:"1"},".line-highlight.line-highlight":{background:"#f7ebc6",boxShadow:"inset 5px 0 0 #f7d87c",zIndex:"0"}}},1876:function(e,t,a){"use strict";var r=a(2784),s=a(36883),n=function(e){var t=window.history,a=t[e];t[e]=function(t){var r=a.apply(this,arguments),s=new Event(e.toLowerCase());return s.state=t,window.dispatchEvent(s),r}};s.jU&&(n("pushState"),n("replaceState"));var l=function(e){var t=window.history,a=t.state,r=t.length,s=window.location;return{trigger:e,state:a,length:r,hash:s.hash,host:s.host,hostname:s.hostname,href:s.href,origin:s.origin,pathname:s.pathname,port:s.port,protocol:s.protocol,search:s.search}},i="function"==typeof Event;t.Z=s.jU&&i?function(){var e=(0,r.useState)(l("load")),t=e[0],a=e[1];return(0,r.useEffect)(function(){var e=function(){return a(l("popstate"))},t=function(){return a(l("pushstate"))},r=function(){return a(l("replacestate"))};return(0,s.on)(window,"popstate",e),(0,s.on)(window,"pushstate",t),(0,s.on)(window,"replacestate",r),function(){(0,s.S1)(window,"popstate",e),(0,s.S1)(window,"pushstate",t),(0,s.S1)(window,"replacestate",r)}},[]),t}:function(){return{trigger:"load",length:1}}}},function(e){e.O(0,[4847,246,8461,4235,2123,2493,8092,6645,2236,6562,5532,1682,614,8707,4071,549,6764,2888,9774,179],function(){return e(e.s=79151)}),_N_E=e.O()}]);